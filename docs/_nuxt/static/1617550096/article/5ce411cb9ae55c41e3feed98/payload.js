__NUXT_JSONP__("/article/5ce411cb9ae55c41e3feed98", {data:[{article:{_id:"5ce411cb9ae55c41e3feed98",meta:{createDate:"2019-05-21 22:57:15",updateDate:"2019-05-21 22:59:01"},tags:["vue"],title:"vue源码阅读之响应式原理",content:"\u003Cp\u003EVue 中对数据的响应式，即对 \u003Ccode\u003Eprops\u003C\u002Fcode\u003E、\u003Ccode\u003Edata\u003C\u002Fcode\u003E、\u003Ccode\u003Ecomputed\u003C\u002Fcode\u003E 的变化进行响应式更改。\u003C\u002Fp\u003E\n\u003Cp\u003E其入口是在 \u003Ccode\u003Esrc\u002Fcore\u002Finstance\u002Finit.js\u003C\u002Fcode\u003E 里的 \u003Ccode\u003EinitState(vm)\u003C\u002Fcode\u003E 里进行实现的。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003EinitState(vm)\u003C\u002Fcode\u003E 里 初始化了 \u003Ccode\u003Eprops\u003C\u002Fcode\u003E, \u003Ccode\u003Emethods\u003C\u002Fcode\u003E, \u003Ccode\u003Edata\u003C\u002Fcode\u003E, \u003Ccode\u003Ecomputed\u003C\u002Fcode\u003E, \u003Ccode\u003Ewatch\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\n\u003Ch3\u003EinitData\u003C\u002Fh3\u003E\n\u003Cp\u003E从 \u003Ccode\u003EinitData\u003C\u002Fcode\u003E 入手来看下：\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EinitData\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Evm\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Component\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E data \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E$options\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Edata\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F 将_data作为中间变量，后续 proxy 里会用到\u003C\u002Fspan\u003E\n  data \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E_data \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Etypeof\u003C\u002Fspan\u003E data \u003Cspan class=\"token operator\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'function'\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EgetData\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Edata\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F getData 做了错误处理，并控制了 Dep.target，使得避免在获取 data 初始值的过程中意外地把依赖记录下来。\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E data \u003Cspan class=\"token operator\"\u003E||\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F 省略相关 warn 代码...\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F 进行 data proxy methods 重复 key 的检验并抛出 warn msg\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F proxy data on instance\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E keys \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E Object\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ekeys\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Edata\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E props \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E$options\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eprops\n  \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E methods \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E$options\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Emethods\n  \u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E i \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E keys\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength\n  \u003Cspan class=\"token keyword\"\u003Ewhile\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ei\u003Cspan class=\"token operator\"\u003E--\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E key \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E keys\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token comment\"\u003E\u002F\u002F 省略相关关于重复 key 检测 warn 代码\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token comment\"\u003E\u002F\u002F 对 _data 对象上的每个 key 进行 getter setter 设置\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token comment\"\u003E\u002F\u002F 使得访问 this.xxx 代理到 this._data.xxx\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token function\"\u003Eproxy\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evm\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token template-string\"\u003E\u003Cspan class=\"token template-punctuation string\"\u003E`\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E_data\u003C\u002Fspan\u003E\u003Cspan class=\"token template-punctuation string\"\u003E`\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E key\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F observe data\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F**\n   * 响应式核心方法\n   * 即 new Observer(value)\n   * 具体看 new Observer(value) 逻辑\n   * *\u002F\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token function\"\u003Eobserve\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Edata\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F* asRootData *\u002F\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003EinitData\u003C\u002Fcode\u003E 里首先将原始 data 复制了份 _data，然后遍历了每个 key，\n通过 \u003Ccode\u003Eproxy\u003C\u002Fcode\u003E 方法对 _data 里的 key 进行了 getter setter 设置。\u003C\u002Fp\u003E\n\u003Cp\u003E使得访问 this.xxx 代理到 this._data.xxx。\u003C\u002Fp\u003E\n\u003Cp\u003E接下来执行 \u003Ccode\u003Eobserve(data, true \u002F* asRootData *\u002F)\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\n\u003Cp\u003E该方法结果是 \u003Ccode\u003Ereturn new Observer(value)\u003C\u002Fcode\u003E，返回了一个 \u003Ccode\u003EObserver\u003C\u002Fcode\u003E 实例。\u003C\u002Fp\u003E\n\u003Ch3\u003EObserver\u003C\u002Fh3\u003E\n\u003Cp\u003E来看下 \u003Ccode\u003EObserver\u003C\u002Fcode\u003E 类的定义，这也是响应式实现的主要地方。\u003C\u002Fp\u003E\n\u003Cdetails\u003E\n  \u003Csummary\u003Eclass Observer 源码\u003C\u002Fsummary\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EObserver\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  value\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E any\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  dep\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Dep\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  vmCount\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E number\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F number of vms that has this object as root $data\u003C\u002Fspan\u003E\n\u003Cp\u003E\u003Cspan class=\"token function\"\u003Econstructor\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Evalue\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E any\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Evalue \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E value\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Edep \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EDep\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EvmCount \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E0\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 添加 \u003Cstrong\u003Eob\u003C\u002Fstrong\u003E 属性，值为自身，即 this.data.\u003Cstrong\u003Eob\u003C\u002Fstrong\u003E = this\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Edef\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E‘\u003Cstrong\u003Eob\u003C\u002Fstrong\u003E’\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EArray\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EisArray\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 对数组原生方法进行了劫持，使得push 等能监控到，来触发响应式，但无法监控到 通过下标更改的情况\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EhasProto\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003EprotoAugment\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E arrayMethods\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003EcopyAugment\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E arrayMethods\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E arrayKeys\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 对数组进行遍历执行 observe\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EobserveArray\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 会进入 walk 方法\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ewalk\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token comment\"\u003E\u002F**\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EWalk through each property and convert them into\u003C\u002Fli\u003E\n\u003Cli\u003Egetter\u002Fsetters. This method should only be called when\u003C\u002Fli\u003E\n\u003Cli\u003Evalue type is Object.\n*\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ewalk\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Eobj\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Object\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E keys \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E Object\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ekeys\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E i \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E i \u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E keys\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E i\u003Cspan class=\"token operator\"\u003E++\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 通过 defineReactive 方法，设置 getter setter, 真正的响应代码\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003EdefineReactive\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E keys\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003E\u003Cspan class=\"token comment\"\u003E\u002F**\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EObserve a list of Array items.\n*\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003EobserveArray\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Eitems\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Array\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003Eany\u003Cspan class=\"token operator\"\u003E&gt;\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E i \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E l \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E items\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E i \u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E l\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E i\u003Cspan class=\"token operator\"\u003E++\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Eobserve\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eitems\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C\u002Fdetails\u003E\n\u003Cp\u003E\u003Ccode\u003EObserver\u003C\u002Fcode\u003E 在 new 的时候，主要逻辑会先执行 \u003Ccode\u003Ethis.dep = new Dep()\u003C\u002Fcode\u003E 来创建依赖实例，然后处理数组\u002F对象的情况。\u003C\u002Fp\u003E\n\u003Cp\u003E这中间还对里面的每个元素进行了深度遍历，使得每个元素均是响应式的。\u003C\u002Fp\u003E\n\u003Cp\u003E再主要来看 \u003Ccode\u003Ethis.walk(value)\u003C\u002Fcode\u003E 方法，该方法通过 \u003Ccode\u003EdefineReactive\u003C\u002Fcode\u003E 方法，设置 getter setter，这是真正的响应代码。\u003C\u002Fp\u003E\n\u003Cdetails\u003E\n  \u003Csummary\u003EdefineReactive 源码\u003C\u002Fsummary\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EdefineReactive\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token parameter\"\u003Eobj\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Object\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n  key\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E string\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n  val\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E any\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n  customSetter\u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003EFunction\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n  shallow\u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E boolean\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F 缓存依赖\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E dep \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EDep\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cp\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E property \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E Object\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EgetOwnPropertyDescriptor\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E key\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eproperty \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E property\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Econfigurable \u003Cspan class=\"token operator\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token comment\"\u003E\u002F\u002F cater for pre-defined getter\u002Fsetters\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 这里代码类比 computed 里属性定义的 getter setter 那样\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 定义了，就用定义的 getter setter 方法\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E getter \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E property \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E property\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eget\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E setter \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E property \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E property\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eset\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003Egetter \u003Cspan class=\"token operator\"\u003E||\u003C\u002Fspan\u003E setter\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E arguments\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength \u003Cspan class=\"token operator\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\nval \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E obj\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ekey\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F childObserve 对象，对 child 进行监听\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E childOb \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003Eshallow \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Eobserve\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eval\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\nObject\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EdefineProperty\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E key\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\nenumerable\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\nconfigurable\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 这步主要收集依赖，并返回值\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function-variable function\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EreactiveGetter\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 兼容使用定义的 getter 情况\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E value \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E getter \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Egetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecall\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E val\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\ndep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Edepend\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EchildOb\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\nchildOb\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Edep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Edepend\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EArray\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EisArray\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003EdependArray\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E value\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 这步触发依赖并设置值\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function-variable function\"\u003Eset\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EreactiveSetter\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003EnewVal\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E value \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E getter \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Egetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecall\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E val\n\u003Cspan class=\"token comment\"\u003E\u002F* eslint-disable no-self-compare \u003Cem\u003E\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EnewVal \u003Cspan class=\"token operator\"\u003E===\u003C\u002Fspan\u003E value \u003Cspan class=\"token operator\"\u003E||\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EnewVal \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E newVal \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E value \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E value\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u003C\u002Fem\u003E eslint-enable no-self-compare *\u002F\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eprocess\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eenv\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token constant\"\u003ENODE_ENV\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E‘production’\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E customSetter\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003EcustomSetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F #7981: for accessor properties without setter\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Egetter \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003Esetter\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 自己定义了 setter 就调用自己的 setter, 没有就直接赋值\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Esetter\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Esetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecall\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E newVal\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\nval \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E newVal\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F newVal 是个 object，则继续递归执行监听 observe\u003C\u002Fspan\u003E\nchildOb \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003Eshallow \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Eobserve\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EnewVal\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 触发更新\u003C\u002Fspan\u003E\ndep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Enotify\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\n\u003C\u002Fdetails\u003E\n\u003Cp\u003E\u003Ccode\u003EdefineReactive\u003C\u002Fcode\u003E 代码可以简化如下：\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token function\"\u003E_defineReactive\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Eobj\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E key\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E val\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E dep \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EDep\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  Object\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EdefineProperty\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E key\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    configurable\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n    enumerable\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token function-variable function\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EreactiveGetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      dep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EaddSub\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E val\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token function-variable function\"\u003Eset\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EreactiveSetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003EnewVal\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E value \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E getter \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Egetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecall\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E val\n      \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EnewVal \u003Cspan class=\"token operator\"\u003E===\u003C\u002Fspan\u003E value\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token comment\"\u003E\u002F\u002F 自己定义了 setter 就调用自己的 setter, 没有就直接赋值\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Esetter\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"token function\"\u003Esetter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecall\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eobj\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E newVal\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n        val \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E newVal\n      \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n      dep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Enotify\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E在 \u003Ccode\u003EdefineReactive\u003C\u002Fcode\u003E 函数内，通过闭包实例化了 \u003Ccode\u003EDep\u003C\u002Fcode\u003E 这个订阅者。\u003C\u002Fp\u003E\n\u003Ch3\u003EDep\u003C\u002Fh3\u003E\n\u003Cdetails\u003E\n  \u003Csummary\u003Eclass Dep 源码\u003C\u002Fsummary\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edefault\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EDep\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Estatic\u003C\u002Fspan\u003E target\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003EWatcher\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  id\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E number\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  subs\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Array\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003EWatcher\u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cp\u003E\u003Cspan class=\"token function\"\u003Econstructor\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eid \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E uid\u003Cspan class=\"token operator\"\u003E++\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esubs \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token function\"\u003EaddSub\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Esub\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Watcher\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esubs\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epush\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Esub\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token function\"\u003EremoveSub\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Esub\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Watcher\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Eremove\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esubs\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E sub\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token function\"\u003Edepend\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F Dep.target 即 watcher：watcher.addDep(dep)\u003C\u002Fspan\u003E\nDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EaddDep\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token function\"\u003Enotify\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F stabilize the subscriber list first\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E subs \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esubs\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eslice\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eprocess\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eenv\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token constant\"\u003ENODE_ENV\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E‘production’\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003Econfig\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Easync\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F subs aren’t sorted in scheduler if not running async\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F we need to sort them now to make sure they fire in correct\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F order\u003C\u002Fspan\u003E\nsubs\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Esort\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Ea\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E b\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=&gt;\u003C\u002Fspan\u003E a\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eid \u003Cspan class=\"token operator\"\u003E-\u003C\u002Fspan\u003E b\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eid\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E i \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E l \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E subs\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E i \u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003E l\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E i\u003Cspan class=\"token operator\"\u003E++\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\nsubs\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ei\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eupdate\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token comment\"\u003E\u002F\u002F the current target watcher being evaluated.\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F this is globally unique because there could be only one\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F watcher being evaluated at any time.\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 保存当前全局唯一存在的 watcher\u003C\u002Fspan\u003E\nDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enull\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E targetStack \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token keyword\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EpushTarget\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003E_target\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003EWatcher\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E targetStack\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epush\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\nDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E _target\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token keyword\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EpopTarget\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\nDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E targetStack\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epop\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\n\u003C\u002Fdetails\u003E\n\u003Cp\u003E\u003Ccode\u003EDep\u003C\u002Fcode\u003E 这里可以简化为：\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EDep\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token function\"\u003Econstructor\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esubs \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token function\"\u003EaddSub\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Esub\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esubs\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epush\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Esub\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token function\"\u003Enotify\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esubs\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EforEach\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Esub\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      sub\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eupdate\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cp\u003EDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enull\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003EDep\u003C\u002Fcode\u003E 这个依赖订阅者，有自己的 \u003Ccode\u003Esubs\u003C\u002Fcode\u003E 用来缓存 \u003Ccode\u003EDep.target\u003C\u002Fcode\u003E，\u003Ccode\u003EDep.target\u003C\u002Fcode\u003E 其实是一个 watcher 实例，这里先不管 watcher。\n回到 \u003Ccode\u003EdefineReactive\u003C\u002Fcode\u003E，在 get 里将 watcher 实例添加到订阅者 Dep 里，\n在 set 时遍历缓存在 dep.subs 数组里的 watcher 实例，执行 \u003Ccode\u003Ewatcher.update()\u003C\u002Fcode\u003E 方法，来触发更新。\u003C\u002Fp\u003E\n\u003Ch3\u003EWatcher\u003C\u002Fh3\u003E\n\u003Cp\u003E来看下 class Watcher\u003C\u002Fp\u003E\n\u003Cdetails\u003E\n  \u003Csummary\u003Eclass Watcher 源码\u003C\u002Fsummary\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E  \u003Cspan class=\"token keyword\"\u003Eexport\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edefault\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EWatcher\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    vm\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Component\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F 实例自身\u003C\u002Fspan\u003E\n    expression\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E string\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    cb\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Function\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    id\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E number\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    deep\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E boolean\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    user\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E boolean\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    lazy\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E boolean\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    sync\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E boolean\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    dirty\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E boolean\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    active\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E boolean\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    deps\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Array\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003EDep\u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    newDeps\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Array\u003Cspan class=\"token operator\"\u003E&lt;\u003C\u002Fspan\u003EDep\u003Cspan class=\"token operator\"\u003E\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    depIds\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E SimpleSet\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F ES6 set 类型\u003C\u002Fspan\u003E\n    newDepIds\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E SimpleSet\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F ES6 set 类型\u003C\u002Fspan\u003E\n    before\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003EFunction\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    getter\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Function\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    value\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E any\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cpre\u003E\u003Ccode\u003E&lt;span class=&quot;token function&quot;&gt;constructor&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;\n  vm&lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; Component&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt;\n  expOrFn&lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; string &lt;span class=&quot;token operator&quot;&gt;|&lt;\u002Fspan&gt; Function&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F 表达式本身 [ getter | noop ]&lt;\u002Fspan&gt;\n  cb&lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; Function&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F [ noop ]&lt;\u002Fspan&gt;\n  options&lt;span class=&quot;token operator&quot;&gt;?&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;?&lt;\u002Fspan&gt;Object&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F { lazy: true } \u002F\u002F 如果设置为 true 则在第一次 get 的时候才计算值，初始化的时候并不计算。init 时为 true&lt;\u002Fspan&gt;\n  isRenderWatcher&lt;span class=&quot;token operator&quot;&gt;?&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; boolean\n&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;vm &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; vm\n  &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;isRenderWatcher&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    vm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;_watcher &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  vm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;_watchers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F options&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;options&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deep &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deep\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;user &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;user\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;lazy &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;lazy\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;sync &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;sync\n    &lt;span class=&quot;token comment&quot;&gt;\u002F*\n    before作用是定义 beforeUpdate 钩子：\n    「\n      before () {\n          if (vm._isMounted) {\n            callHook(vm, 'beforeUpdate')\n          }\n        }\n      」\n    *\u002F&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;before &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; options&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;before\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deep &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;user &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;lazy &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;sync &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;cb &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; cb\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;id &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;\u002Fspan&gt;uid &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F uid for batching&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;active &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;dirty &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;lazy &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F for lazy watchers&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F 两个数组，&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDeps &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F 两个id 为 set 实例,在 add 时候，防止重复添加相同 id&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;depIds &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;\u002Fspan&gt; &lt;span class=&quot;token class-name&quot;&gt;Set&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDepIds &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;\u002Fspan&gt; &lt;span class=&quot;token class-name&quot;&gt;Set&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;expression &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token constant&quot;&gt;NODE_ENV&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;\u002Fspan&gt; &lt;span class=&quot;token string&quot;&gt;'production'&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token operator&quot;&gt;?&lt;\u002Fspan&gt; expOrFn&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; &lt;span class=&quot;token string&quot;&gt;''&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F parse expression for getter&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;typeof&lt;\u002Fspan&gt; expOrFn &lt;span class=&quot;token operator&quot;&gt;===&lt;\u002Fspan&gt; &lt;span class=&quot;token string&quot;&gt;'function'&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;getter &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; expOrFn\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;getter &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token function&quot;&gt;parsePath&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;expOrFn&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;getter&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;getter &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; noop\n      process&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;env&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token constant&quot;&gt;NODE_ENV&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;\u002Fspan&gt; &lt;span class=&quot;token string&quot;&gt;'production'&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;\u002Fspan&gt; &lt;span class=&quot;token function&quot;&gt;warn&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;\n        &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;Failed watching path: &quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;\u002Fspan&gt;expOrFn&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;&quot; &lt;\u002Fspan&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;\u002Fspan&gt;&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;\u002Fspan&gt;\n        &lt;span class=&quot;token string&quot;&gt;'Watcher only accepts simple dot-delimited paths. '&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;\u002Fspan&gt;\n        &lt;span class=&quot;token string&quot;&gt;'For full control, use a function instead.'&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt;\n        vm\n      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;lazy\n    &lt;span class=&quot;token operator&quot;&gt;?&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;undefined&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Evaluate the getter, and re-collect dependencies.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token comment&quot;&gt;\u002F\u002F 执行 getter, 并重新收集依赖关系&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;get&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F* pushTarget 代码：\n  「\n      Dep.target = null\n      const targetStack = []\n\n      export function pushTarget (_target: ?Watcher) {\n        if (Dep.target) targetStack.push(Dep.target)\n        Dep.target = _target\n      }\n\n      export function popTarget () {\n        Dep.target = targetStack.pop()\n      }\n    」\n  *\u002F&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F 这行代码作用：在进行 get 取值时，使得 Dep.target 为 watcher 实例自身&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token function&quot;&gt;pushTarget&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;let&lt;\u002Fspan&gt; value\n  &lt;span class=&quot;token keyword&quot;&gt;const&lt;\u002Fspan&gt; vm &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;vm\n  &lt;span class=&quot;token keyword&quot;&gt;try&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    value &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;getter&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;vm&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; vm&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;user&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token function&quot;&gt;handleError&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;e&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; vm&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;getter for watcher &quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;expression&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token keyword&quot;&gt;throw&lt;\u002Fspan&gt; e\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;finally&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F &quot;touch&quot; every property so they are all tracked as&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F dependencies for deep watching&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deep&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token function&quot;&gt;traverse&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token function&quot;&gt;popTarget&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;cleanupDeps&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;return&lt;\u002Fspan&gt; value\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Add a dependency to this directive.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;addDep&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token parameter&quot;&gt;dep&lt;span class=&quot;token operator&quot;&gt;:&lt;\u002Fspan&gt; Dep&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;const&lt;\u002Fspan&gt; id &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;id\n  &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F if (!this.newDepIds.has(id)) 判断，为了防止如 computed 里&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F `return this.a + this.a` 这种相同值的计算情况&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDepIds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;has&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDepIds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDeps&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;dep&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;depIds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;has&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;addSub&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Clean up for dependency collection.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;cleanupDeps&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;let&lt;\u002Fspan&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;length\n  &lt;span class=&quot;token keyword&quot;&gt;while&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;i&lt;span class=&quot;token operator&quot;&gt;--&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;const&lt;\u002Fspan&gt; dep &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps&lt;span class=&quot;token punctuation&quot;&gt;[&lt;\u002Fspan&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDepIds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;has&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;id&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      dep&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;removeSub&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;let&lt;\u002Fspan&gt; tmp &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;depIds\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;depIds &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDepIds\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDepIds &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; tmp\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDepIds&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;clear&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  tmp &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDeps\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDeps &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; tmp\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;newDeps&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;length &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Subscriber interface.\n * Will be called when a dependency changes.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;update&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token comment&quot;&gt;\u002F* istanbul ignore else *\u002F&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;lazy&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;dirty &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;sync&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token function&quot;&gt;queueWatcher&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Scheduler job interface.\n * Will be called by the scheduler.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;run&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;active&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;const&lt;\u002Fspan&gt; value &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;\n      value &lt;span class=&quot;token operator&quot;&gt;!==&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;value &lt;span class=&quot;token operator&quot;&gt;||&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F Deep watchers and watchers on Object\u002FArrays should fire even&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F when the value is the same, because the value may&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F have mutated.&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token function&quot;&gt;isObject&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deep\n    &lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F set new value&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token keyword&quot;&gt;const&lt;\u002Fspan&gt; oldValue &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;value\n      &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; value\n      &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;user&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n        &lt;span class=&quot;token keyword&quot;&gt;try&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n          &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;cb&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;vm&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; oldValue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n          &lt;span class=&quot;token function&quot;&gt;handleError&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;e&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;vm&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; &lt;span class=&quot;token template-string&quot;&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;callback for watcher &quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;expression&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;`&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n        &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;cb&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;vm&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; value&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; oldValue&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Evaluate the value of the watcher.\n * This only gets called for lazy watchers.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;evaluate&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;value &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;dirty &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Depend on all deps collected by this watcher.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;depend&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;let&lt;\u002Fspan&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;length\n  &lt;span class=&quot;token keyword&quot;&gt;while&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;i&lt;span class=&quot;token operator&quot;&gt;--&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps&lt;span class=&quot;token punctuation&quot;&gt;[&lt;\u002Fspan&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;depend&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\n&lt;span class=&quot;token comment&quot;&gt;\u002F**\n * Remove self from all dependencies' subscriber list.\n *\u002F&lt;\u002Fspan&gt;\n&lt;span class=&quot;token function&quot;&gt;teardown&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;active&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F remove self from vm's watcher list&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F this is a somewhat expensive operation so we skip it&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token comment&quot;&gt;\u002F\u002F if the vm is being destroyed.&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;if&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;vm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;_isBeingDestroyed&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token function&quot;&gt;remove&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;vm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;_watchers&lt;span class=&quot;token punctuation&quot;&gt;,&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;let&lt;\u002Fspan&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;length\n    &lt;span class=&quot;token keyword&quot;&gt;while&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;i&lt;span class=&quot;token operator&quot;&gt;--&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;\u002Fspan&gt;\n      &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;deps&lt;span class=&quot;token punctuation&quot;&gt;[&lt;\u002Fspan&gt;i&lt;span class=&quot;token punctuation&quot;&gt;]&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;&lt;span class=&quot;token function&quot;&gt;removeSub&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;\u002Fspan&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n    &lt;span class=&quot;token keyword&quot;&gt;this&lt;\u002Fspan&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;\u002Fspan&gt;active &lt;span class=&quot;token operator&quot;&gt;=&lt;\u002Fspan&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;\u002Fspan&gt;\n  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n&lt;span class=&quot;token punctuation&quot;&gt;}&lt;\u002Fspan&gt;\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\n\u003C\u002Fdetails\u003E\n\u003Cp\u003E上面说到在 set 某个值的时候，实际上会执行 \u003Ccode\u003Ewatcher.update()\u003C\u002Fcode\u003E 方法。来看下这个 update 方法：\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token function\"\u003Eupdate\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F* istanbul ignore else *\u002F\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elazy\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Edirty \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Esync\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Erun\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token function\"\u003EqueueWatcher\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003Eupdate 方法，同步情况执行 \u003Ccode\u003Ethis.run()\u003C\u002Fcode\u003E ，一般情况是异步，会进入到最后个 else 里，执行 \u003Ccode\u003EqueueWatcher(this)\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003EqueueWatcher\u003C\u002Fcode\u003E 里主要代码 \u003Ccode\u003EnextTick(flushSchedulerQueue)\u003C\u002Fcode\u003E，它将 watch 队列放到 nextTick 里统一执行，这也使得连续 set 同个数据两次不同值，不会更新两次视图，提升了一定性能。\u003C\u002Fp\u003E\n\u003Ch3\u003Ecomputed 的原理\u003C\u002Fh3\u003E\n\u003Cp\u003E注意 watcher 实例化 constructor 最后行有个 \u003Ccode\u003Ethis.value\u003C\u002Fcode\u003E:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Evalue \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elazy\n  \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eundefined\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eget\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E这个 value，在 \u003Ccode\u003EinitComputed\u003C\u002Fcode\u003E 的时候，会对 computed 里的每个 key \u003Ccode\u003Enew Watcher(...)\u003C\u002Fcode\u003E，所以可以说是 computed 的双向绑定实现即是通过 Watcher 来响应变化。\u003C\u002Fp\u003E\n\u003Cdetails\u003E\n  \u003Csummary\u003EinitComputed 源码函数：\u003C\u002Fsummary\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E computedWatcherOptions \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E lazy\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token boolean\"\u003Etrue\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cp\u003E\u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EinitComputed\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Evm\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Component\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E computed\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Object\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F $flow-disable-line\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E watchers \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E_computedWatchers \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E Object\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecreate\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F computed properties are just getters during SSR\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E isSSR \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EisServerRendering\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cspan class=\"token comment\"\u003E\u002F\u002F 遍历定义在 computed 上的 key\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Efor\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E key \u003Cspan class=\"token keyword\"\u003Ein\u003C\u002Fspan\u003E computed\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E userDef \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E computed\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ekey\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 处理自定义 getter 情况\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E getter \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Etypeof\u003C\u002Fspan\u003E userDef \u003Cspan class=\"token operator\"\u003E===\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E‘function’\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E userDef \u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E userDef\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eget\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eprocess\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eenv\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token constant\"\u003ENODE_ENV\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E‘production’\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E getter \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enull\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ewarn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n\u003Cspan class=\"token template-string\"\u003E\u003Cspan class=\"token template-punctuation string\"\u003E\u003Ccode\u003E&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;Getter is missing for computed property &quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;\u002Fspan&gt;key&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;&quot;.&lt;\u002Fspan&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;\u003C\u002Fcode\u003E\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\nvm\n\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 非 ssr 情况，对 key 进行 监控，ssr 下就不需要监控了\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003EisSSR\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F create internal watcher for the computed property.\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 对每个key 设置 Watcher\u003C\u002Fspan\u003E\nwatchers\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ekey\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"token class-name\"\u003EWatcher\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\nvm\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\ngetter \u003Cspan class=\"token operator\"\u003E||\u003C\u002Fspan\u003E noop\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\nnoop\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E\ncomputedWatcherOptions\n\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F component-defined computed properties are already defined on the\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F component prototype. We only need to define computed properties defined\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F at instantiation here.\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E!\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ekey \u003Cspan class=\"token keyword\"\u003Ein\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token comment\"\u003E\u002F\u002F 将 computed 里定义的 key 在实例上添加进行代理，使得可直接通过 this.xx 来访问\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003EdefineComputed\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evm\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E key\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E userDef\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eprocess\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eenv\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token constant\"\u003ENODE_ENV\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E‘production’\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ekey \u003Cspan class=\"token keyword\"\u003Ein\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E$data\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ewarn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token template-string\"\u003E\u003Cspan class=\"token template-punctuation string\"\u003E\u003Ccode\u003E&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;The computed property &quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;\u002Fspan&gt;key&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;&quot; is already defined in data.&lt;\u002Fspan&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;\u003C\u002Fcode\u003E\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eelse\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E$options\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eprops \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E key \u003Cspan class=\"token keyword\"\u003Ein\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E$options\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Eprops\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ewarn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token template-string\"\u003E\u003Cspan class=\"token template-punctuation string\"\u003E\u003Ccode\u003E&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;The computed property &quot;&lt;\u002Fspan&gt;&lt;span class=&quot;token interpolation&quot;&gt;&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;${&lt;\u002Fspan&gt;key&lt;span class=&quot;token interpolation-punctuation punctuation&quot;&gt;}&lt;\u002Fspan&gt;&lt;\u002Fspan&gt;&lt;span class=&quot;token string&quot;&gt;&quot; is already defined as a prop.&lt;\u002Fspan&gt;&lt;span class=&quot;token template-punctuation string&quot;&gt;\u003C\u002Fcode\u003E\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E vm\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fp\u003E\n\u003C\u002Fdetails\u003E\n\u003Cp\u003E从上面传入参数 \u003Ccode\u003E{ lazy: true }\u003C\u002Fcode\u003E 可知，初始化时 value 为 \u003Ccode\u003Eundefined\u003C\u002Fcode\u003E，\n\u003Ccode\u003EdefineComputed(vm, key, userDef)\u003C\u002Fcode\u003E 即 \u003Ccode\u003EObject.defineProperty(target, key, sharedPropertyDefinition)\u003C\u002Fcode\u003E.\n在 \u003Ccode\u003EsharedPropertyDefinition\u003C\u002Fcode\u003E 里会拿之前 watcher 过的依赖的值：\u003C\u002Fp\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EcreateComputedGetter\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Ekey\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EcomputedGetter\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E watcher \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E_computedWatchers \u003Cspan class=\"token operator\"\u003E&amp;&amp;\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E_computedWatchers\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Ekey\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ewatcher\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ewatcher\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Edirty\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n        watcher\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eevaluate\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EDep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Etarget\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n        watcher\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Edepend\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E watcher\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Evalue\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E所以 computed 中的值在读取的时候，拿到的结果即 watcher.value。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003E总结下 data 响应式流程：\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Ethis.xx 代理到 this._data.xx 然后 _data 在 Observer 里定义过 setter getter，在初始 render 时会收集依赖到闭包的 Dep 依赖实例的数组里，在 setter 时会通知所有依赖即每个 watcher 实例进行 update 更新。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003E总结下 computed 响应式流程：\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Ethis.xx 初始化时会先创建一个 watcher，然后通过 \u003Ccode\u003EObject.defineProperty\u003C\u002Fcode\u003E 进行 setter,getter 设置，其中 getter 会得到是 watcher.value 的值。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003E注意：\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003EObserver 文件下定义了个 \u003Ccode\u003EarrayMethods\u003C\u002Fcode\u003E，该方法重写了数组方法，使得改变 push 等操作也能触发更新。\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cpre class=\"language-js\"\u003E\u003Ccode\u003EmethodsToPatch\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EforEach\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Emethod\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F cache original method\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E original \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E arrayProto\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003Emethod\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token function\"\u003Edef\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EarrayMethods\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E method\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Emutator\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003E\u003Cspan class=\"token operator\"\u003E...\u003C\u002Fspan\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E result \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Eoriginal\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eapply\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E args\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E ob \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E__ob__\n    \u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E inserted\n    \u003Cspan class=\"token keyword\"\u003Eswitch\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Emethod\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'push'\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'unshift'\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E\n        inserted \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E args\n        \u003Cspan class=\"token keyword\"\u003Ebreak\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'splice'\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E\n        inserted \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E args\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eslice\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token number\"\u003E2\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n        \u003Cspan class=\"token keyword\"\u003Ebreak\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Einserted\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E ob\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EobserveArray\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Einserted\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token comment\"\u003E\u002F\u002F notify change\u003C\u002Fspan\u003E\n    ob\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Edep\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Enotify\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E result\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E附：\n\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Ftanxchen\u002Fknowledge-note\u002Fblob\u002Fmaster\u002F%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6\u002Fvuejs\u002Fmvvm.html#L1-L137\"\u003E实现vue精简版响应式代码\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n",__v:0}}],fetch:{},mutations:void 0});