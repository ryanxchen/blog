<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>TanxChen'blog</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"><meta data-n-head="ssr" name="keywords" content="ryanx chen blog"><meta data-n-head="ssr" data-hid="description" name="description" content="Tanx Chen's blog 编程&前端&记录总结个人成长"><base href="/blog/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script data-n-head="ssr" src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="preload" href="/blog/_nuxt/b9a28b3.js" as="script"><link rel="preload" href="/blog/_nuxt/c57fec5.js" as="script"><link rel="preload" href="/blog/_nuxt/4f157bc.js" as="script"><link rel="preload" href="/blog/_nuxt/798d0e7.js" as="script"><link rel="preload" href="/blog/_nuxt/22474fa.js" as="script"><link rel="preload" href="/blog/_nuxt/c1e6e7d.js" as="script"><link rel="preload" href="/blog/_nuxt/e7fe387.js" as="script"><style data-vue-ssr-id="3a312388:0 f52d43e0:0 9b3ab808:0 fa7ff0ca:0 56b15182:0 9156c51a:0 01b54bb1:0 762dd866:0">a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,main,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}[hidden]{display:none}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:"";content:none}table{border-collapse:collapse;border-spacing:0}body,html{background-color:#fff;color:#000;letter-spacing:.5px;font-family:"Source Sans Pro",Arial,sans-serif;margin:0}a,a:focus,a:hover,a:visited{color:#000;text-decoration:none}a.link{color:#2196f3}.post{padding:25px 0 15px}.post .post-title{margin:0;color:#555;text-align:left;font:700 25px/1.1 ff-tisa-web-pro,Cambria,"Times New Roman",Georgia,Times,sans-serif}.post-title a{position:relative}.post-title a:hover:after{opacity:1;transform:scaleX(1)}.post-title a:after{position:absolute;bottom:-4px;left:0;right:0;height:3px;background:#000;content:"";opacity:0;transition:transform .1s ease-in;transform:scaleX(0)}.post .post-meta{padding:0;margin:15px 0 0;color:#6e7173;display:inline-block;text-indent:.15em}.post .post-meta:before{font-family:FontAwesome;content:"\f073";padding-right:.3em}.post .post-content{clear:left;font-size:16px;line-height:1.5;color:#444;padding-top:15px;text-align:justify;word-break:break-all}.readmore{padding:20px 0;text-align:right}.readmore a{font-size:14px;color:#444;padding:5px 10px;border:1px solid #ddd;border-radius:5px}.readmore a:hover{border:1px solid #999}.readmore a:after{font-family:FontAwesome;content:"\f101";padding-left:.3em}.blog-comments-wrap{padding-bottom:20px}.mdcontent h1,.mdcontent h2,.mdcontent h3,.mdcontent h4,.mdcontent h5,.mdcontent h6{font-weight:600;line-height:1.25;margin-bottom:16px;margin-top:24px}.mdcontent h1,.mdcontent h2{border-bottom:1px solid #eaecef;padding-bottom:.3em}.mdcontent h1{font-size:2em}.mdcontent h2{font-size:1.5em}.mdcontent code{background-color:#f6f8fa;padding:4px 6px;border-radius:4px}.mdcontent code a{background-color:rgba(27,31,35,.05)}.mdcontent p{margin:6px 0}.mdcontent blockquote{border-left:.25em solid #dfe2e5;color:#6a737d;padding:0 1em}.mdcontent li,.mdcontent ul{margin:initial;padding:initial}.mdcontent ul{padding-left:2em;margin-bottom:16px;margin-top:0}.mdcontent li{list-style:disc outside none;list-style:initial}.mdcontent img{max-width:100%}.mdcontent table{margin-bottom:16px;margin-top:0;border-collapse:collapse;border-spacing:0}.mdcontent table td,.mdcontent table th{border:1px solid #dfe2e5;padding:6px 13px;text-align:center}.mdcontent pre,.mdcontent pre[class*=language-]{border:1px solid #eaecef;background-color:#f6f8fa;padding:10px 20px;border-radius:4px;font-size:85%;line-height:1.45;overflow:auto;margin:10px 0}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#e91e63}.mdcontent pre code,.mdcontent pre[class*=language-] code{color:#525252}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#389d70}.token.punctuation{color:#2973b7}.token.boolean,.token.function,.token.number{color:#e96900}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#b3b3b3}.token.entity,.token.operator,.token.url{color:#cd6767}.token.tag{color:#3ca0e6}.token.attr-name,.token.deleted,.token.namespace{color:#fc9153}.token.punctuation{color:#666}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#3fb374}.token.property{color:#4a90e2}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.body-container{max-width:720px;min-width:320px;box-sizing:border-box;margin:0 auto;min-height:100vh;padding-bottom:60px}@media screen and (max-width:720px){.body-container{padding:0 20px 60px}}.desc[data-v-98330b66]{height:64px;box-sizing:border-box;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.desc[data-v-98330b66] *{margin:0!important;line-height:24px!important;font-size:16px!important;font-weight:400!important;padding:0!important;border:0!important}.bl-header{padding:20px 0 0;text-align:left;border-bottom:1px solid #ddd;position:relative;margin-bottom:25px}.site-name{margin-bottom:40px}.description{margin:.2em 0 0;color:#999}.nav-menu{margin:10px 0 -1px;padding:0;position:absolute;right:0;bottom:0}.nav-menu a{display:inline-block;padding:3px 20px;line-height:30px;color:#444;font-size:13px;border:1px solid transparent}.nav-menu a.nuxt-link-exact-active{border:1px solid;border-color:#ddd #ddd #fff}.bl-footer{border-top:1px solid #e5e5e5;max-width:720px;margin-left:auto;margin-right:auto;line-height:1.4;height:60px;box-sizing:border-box}.footer-wrap{display:flex;align-items:center;justify-content:center;height:100%;flex-flow:wrap}</style><link rel="preload" href="/blog/_nuxt/static/1636300541/state.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/payload.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><section class="container body-container" data-v-98330b66><div class="bl-header" data-v-98330b66><div class="site-name"><a href="/blog/" aria-current="page" class="nuxt-link-exact-active nuxt-link-active"><img src="/blog/_nuxt/img/logo_200_200.fc1fc4c.png" alt="logo" style="width:40px;height:40px;border-radius:5px"></a> <p class="description">Stay Hungry. Stay Foolish.</p></div> <div class="nav-menu"><a href="/blog/" aria-current="page" class="current nuxt-link-exact-active nuxt-link-active"><i class="fa fa-home"> 首页</i></a> <a href="/blog/about"><i class="fa fa-user"> 关于</i></a></div></div> <div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5ce411cb9ae55c41e3feed98" data-v-98330b66>
        vue源码阅读之响应式原理
      </a></h1> <div class="post-meta" data-v-98330b66>2019-05-21 22:57:15</div> <div class="post-content mdcontent desc" data-v-98330b66><p>Vue 中对数据的响应式，即对 <code>props</code>、<code>data</code>、<code>computed</code> 的变化进行响应式更改。</p>
<p>其入口是在 <code>src/core/instance/init.js</code> 里的 <code>initState(vm)</code> 里进行实现的。</p>
<p><code>initState(vm)</code> 里 初始化了 <code>props</code>, <code>methods</code>, <code>data</code>, <code>computed</code>, <code>watch</code>。</p>
<h3>initData</h3>
<p>从 <code>initData</code> 入手来看下：</p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initData</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data
  <span class="token comment">// 将_data作为中间变量，后续 proxy 里会用到</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token comment">// getData 做了错误处理，并控制了 Dep.target，使得避免在获取 data 初始值的过程中意外地把依赖记录下来。</span>
    <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 省略相关 warn 代码...</span>
  <span class="token comment">// 进行 data proxy methods 重复 key 的检验并抛出 warn msg</span>
  <span class="token comment">// proxy data on instance</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">// 省略相关关于重复 key 检测 warn 代码</span>
    <span class="token comment">// 对 _data 对象上的每个 key 进行 getter setter 设置</span>
    <span class="token comment">// 使得访问 this.xxx 代理到 this._data.xxx</span>
    <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// observe data</span>
  <span class="token comment">/**
   * 响应式核心方法
   * 即 new Observer(value)
   * 具体看 new Observer(value) 逻辑
   * */</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>initData</code> 里首先将原始 data 复制了份 _data，然后遍历了每个 key，
通过 <code>proxy</code> 方法对 _data 里的 key 进行了 getter setter 设置。</p>
<p>使得访问 this.xxx 代理到 this._data.xxx。</p>
<p>接下来执行 <code>observe(data, true /* asRootData */)</code>。</p>
<p>该方法结果是 <code>return new Observer(value)</code>，返回了一个 <code>Observer</code> 实例。</p>
<h3>Observer</h3>
<p>来看下 <code>Observer</code> 类的定义，这也是响应式实现的主要地方。</p>
<details>
  <summary>class Observer 源码</summary>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> any<span class="token punctuation">;</span>
  dep<span class="token operator">:</span> Dep<span class="token punctuation">;</span>
  vmCount<span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">// number of vms that has this object as root $data</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 添加 __ob__ 属性，值为自身，即 this.data.__ob__ = this</span>
    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对数组原生方法进行了劫持，使得push 等能监控到，来触发响应式，但无法监控到 通过下标更改的情况</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 对数组进行遍历执行 observe</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 会进入 walk 方法</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Walk through each property and convert them into
   * getter/setters. This method should only be called when
   * value type is Object.
   */</span>
  <span class="token function">walk</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过 defineReactive 方法，设置 getter setter, 真正的响应代码</span>
      <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Observe a list of Array items.
   */</span>
  <span class="token function">observeArray</span> <span class="token punctuation">(</span><span class="token parameter">items<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</details>
<p><code>Observer</code> 在 new 的时候，主要逻辑会先执行 <code>this.dep = new Dep()</code> 来创建依赖实例，然后处理数组/对象的情况。</p>
<p>这中间还对里面的每个元素进行了深度遍历，使得每个元素均是响应式的。</p>
<p>再主要来看 <code>this.walk(value)</code> 方法，该方法通过 <code>defineReactive</code> 方法，设置 getter setter，这是真正的响应代码。</p>
<details>
  <summary>defineReactive 源码</summary>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span>
  <span class="token parameter">obj<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string<span class="token punctuation">,</span>
  val<span class="token operator">:</span> any<span class="token punctuation">,</span>
  customSetter<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
  shallow<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 缓存依赖</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&&</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// cater for pre-defined getter/setters</span>
  <span class="token comment">// 这里代码类比 computed 里属性定义的 getter setter 那样</span>
  <span class="token comment">// 定义了，就用定义的 getter setter 方法</span>
  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&&</span> property<span class="token punctuation">.</span>get
  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&&</span> property<span class="token punctuation">.</span>set
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&&</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// childObserve 对象，对 child 进行监听</span>
  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&&</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 这步主要收集依赖，并返回值</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 兼容使用定义的 getter 情况</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 这步触发依赖并设置值</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
      <span class="token comment">/* eslint-disable no-self-compare */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&&</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* eslint-enable no-self-compare */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&&</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// #7981: for accessor properties without setter</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&&</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token comment">// 自己定义了 setter 就调用自己的 setter, 没有就直接赋值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> newVal
      <span class="token punctuation">}</span>
      <span class="token comment">// newVal 是个 object，则继续递归执行监听 observe</span>
      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&&</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
      <span class="token comment">// 触发更新</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</details>
<p><code>defineReactive</code> 代码可以简化如下：</p>
<pre class="language-js"><code><span class="token function">_defineReactive</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token comment">// 自己定义了 setter 就调用自己的 setter, 没有就直接赋值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> newVal
      <span class="token punctuation">}</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在 <code>defineReactive</code> 函数内，通过闭包实例化了 <code>Dep</code> 这个订阅者。</p>
<h3>Dep</h3>
<details>
  <summary>class Dep 源码</summary>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> target<span class="token operator">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">;</span>
  id<span class="token operator">:</span> number<span class="token punctuation">;</span>
  subs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter">sub<span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">removeSub</span> <span class="token punctuation">(</span><span class="token parameter">sub<span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Dep.target 即 watcher：watcher.addDep(dep)</span>
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// stabilize the subscriber list first</span>
    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&&</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// subs aren't sorted in scheduler if not running async</span>
      <span class="token comment">// we need to sort them now to make sure they fire in correct</span>
      <span class="token comment">// order</span>
      subs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// the current target watcher being evaluated.</span>
<span class="token comment">// this is globally unique because there could be only one</span>
<span class="token comment">// watcher being evaluated at any time.</span>
<span class="token comment">// 保存当前全局唯一存在的 watcher</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span> <span class="token punctuation">(</span><span class="token parameter">_target<span class="token operator">:</span> <span class="token operator">?</span>Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> _target
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popTarget</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</details>
<p><code>Dep</code> 这里可以简化为：</p>
<pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre>
<p><code>Dep</code> 这个依赖订阅者，有自己的 <code>subs</code> 用来缓存 <code>Dep.target</code>，<code>Dep.target</code> 其实是一个 watcher 实例，这里先不管 watcher。
回到 <code>defineReactive</code>，在 get 里将 watcher 实例添加到订阅者 Dep 里，
在 set 时遍历缓存在 dep.subs 数组里的 watcher 实例，执行 <code>watcher.update()</code> 方法，来触发更新。</p>
<h3>Watcher</h3>
<p>来看下 class Watcher</p>
<details>
  <summary>class Watcher 源码</summary>
<pre class="language-js"><code>  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    vm<span class="token operator">:</span> Component<span class="token punctuation">;</span> <span class="token comment">// 实例自身</span>
    expression<span class="token operator">:</span> string<span class="token punctuation">;</span>
    cb<span class="token operator">:</span> Function<span class="token punctuation">;</span>
    id<span class="token operator">:</span> number<span class="token punctuation">;</span>
    deep<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    user<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    lazy<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    sync<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    dirty<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    active<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    deps<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>
    newDeps<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>
    depIds<span class="token operator">:</span> SimpleSet<span class="token punctuation">;</span> <span class="token comment">// ES6 set 类型</span>
    newDepIds<span class="token operator">:</span> SimpleSet<span class="token punctuation">;</span> <span class="token comment">// ES6 set 类型</span>
    before<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">;</span>
    getter<span class="token operator">:</span> Function<span class="token punctuation">;</span>
    value<span class="token operator">:</span> any<span class="token punctuation">;</span>

    <span class="token function">constructor</span> <span class="token punctuation">(</span>
      vm<span class="token operator">:</span> Component<span class="token punctuation">,</span>
      expOrFn<span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span> <span class="token comment">// 表达式本身 [ getter | noop ]</span>
      cb<span class="token operator">:</span> Function<span class="token punctuation">,</span> <span class="token comment">// [ noop ]</span>
      options<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span> <span class="token comment">// { lazy: true } // 如果设置为 true 则在第一次 get 的时候才计算值，初始化的时候并不计算。init 时为 true</span>
      isRenderWatcher<span class="token operator">?</span><span class="token operator">:</span> boolean
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">// options</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep
        <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user
        <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy
        <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync
        <span class="token comment">/*
        before作用是定义 beforeUpdate 钩子：
        「
          before () {
              if (vm._isMounted) {
                callHook(vm, 'beforeUpdate')
              }
            }
          」
        */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
      <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid <span class="token comment">// uid for batching</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token comment">// for lazy watchers</span>
      <span class="token comment">// 两个数组，</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token comment">// 两个id 为 set 实例,在 add 时候，防止重复添加相同 id</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span>
        <span class="token operator">?</span> expOrFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token string">''</span>
      <span class="token comment">// parse expression for getter</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop
          process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&&</span> <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed watching path: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expOrFn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token string">'Watcher only accepts simple dot-delimited paths. '</span> <span class="token operator">+</span>
            <span class="token string">'For full control, use a function instead.'</span><span class="token punctuation">,</span>
            vm
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
        <span class="token operator">?</span> <span class="token keyword">undefined</span>
        <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Evaluate the getter, and re-collect dependencies.
     */</span>
    <span class="token comment">// 执行 getter, 并重新收集依赖关系</span>
    <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* pushTarget 代码：
      「
          Dep.target = null
          const targetStack = []

          export function pushTarget (_target: ?Watcher) {
            if (Dep.target) targetStack.push(Dep.target)
            Dep.target = _target
          }

          export function popTarget () {
            Dep.target = targetStack.pop()
          }
        」
      */</span>
      <span class="token comment">// 这行代码作用：在进行 get 取值时，使得 Dep.target 为 watcher 实例自身</span>
      <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> value
      <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getter for watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> e
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// "touch" every property so they are all tracked as</span>
        <span class="token comment">// dependencies for deep watching</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Add a dependency to this directive.
     */</span>
    <span class="token function">addDep</span> <span class="token punctuation">(</span><span class="token parameter">dep<span class="token operator">:</span> Dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id
      <span class="token comment">// if (!this.newDepIds.has(id)) 判断，为了防止如 computed 里</span>
      <span class="token comment">// `return this.a + this.a` 这种相同值的计算情况</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Clean up for dependency collection.
     */</span>
    <span class="token function">cleanupDeps</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          dep<span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>depIds
      <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> tmp
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps
      <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> tmp
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Subscriber interface.
     * Will be called when a dependency changes.
     */</span>
    <span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore else */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Scheduler job interface.
     * Will be called by the scheduler.
     */</span>
    <span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          value <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">||</span>
          <span class="token comment">// Deep watchers and watchers on Object/Arrays should fire even</span>
          <span class="token comment">// when the value is the same, because the value may</span>
          <span class="token comment">// have mutated.</span>
          <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>deep
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// set new value</span>
          <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value
          <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">callback for watcher "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Evaluate the value of the watcher.
     * This only gets called for lazy watchers.
     */</span>
    <span class="token function">evaluate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Depend on all deps collected by this watcher.
     */</span>
    <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Remove self from all dependencies' subscriber list.
     */</span>
    <span class="token function">teardown</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// remove self from vm's watcher list</span>
        <span class="token comment">// this is a somewhat expensive operation so we skip it</span>
        <span class="token comment">// if the vm is being destroyed.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>_isBeingDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre>
</details>
<p>上面说到在 set 某个值的时候，实际上会执行 <code>watcher.update()</code> 方法。来看下这个 update 方法：</p>
<pre class="language-js"><code><span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* istanbul ignore else */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>update 方法，同步情况执行 <code>this.run()</code> ，一般情况是异步，会进入到最后个 else 里，执行 <code>queueWatcher(this)</code>。</p>
<p><code>queueWatcher</code> 里主要代码 <code>nextTick(flushSchedulerQueue)</code>，它将 watch 队列放到 nextTick 里统一执行，这也使得连续 set 同个数据两次不同值，不会更新两次视图，提升了一定性能。</p>
<h3>computed 的原理</h3>
<p>注意 watcher 实例化 constructor 最后行有个 <code>this.value</code>:</p>
<pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
  <span class="token operator">?</span> <span class="token keyword">undefined</span>
  <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>这个 value，在 <code>initComputed</code> 的时候，会对 computed 里的每个 key <code>new Watcher(...)</code>，所以可以说是 computed 的双向绑定实现即是通过 Watcher 来响应变化。</p>
<details>
  <summary>initComputed 源码函数：</summary>
<pre class="language-js"><code><span class="token keyword">const</span> computedWatcherOptions <span class="token operator">=</span> <span class="token punctuation">{</span> lazy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">initComputed</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span> computed<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// $flow-disable-line</span>
  <span class="token keyword">const</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// computed properties are just getters during SSR</span>
  <span class="token keyword">const</span> isSSR <span class="token operator">=</span> <span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 遍历定义在 computed 上的 key</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token comment">// 处理自定义 getter 情况</span>
    <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> userDef <span class="token operator">:</span> userDef<span class="token punctuation">.</span>get
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&&</span> getter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Getter is missing for computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">".</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 非 ssr 情况，对 key 进行 监控，ssr 下就不需要监控了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSSR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// create internal watcher for the computed property.</span>
      <span class="token comment">// 对每个key 设置 Watcher</span>
      watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
        vm<span class="token punctuation">,</span>
        getter <span class="token operator">||</span> noop<span class="token punctuation">,</span>
        noop<span class="token punctuation">,</span>
        computedWatcherOptions
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// component-defined computed properties are already defined on the</span>
    <span class="token comment">// component prototype. We only need to define computed properties defined</span>
    <span class="token comment">// at instantiation here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将 computed 里定义的 key 在实例上添加进行代理，使得可直接通过 this.xx 来访问</span>
      <span class="token function">defineComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> userDef<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already defined in data.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props <span class="token operator">&&</span> key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The computed property "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" is already defined as a prop.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</details>
<p>从上面传入参数 <code>{ lazy: true }</code> 可知，初始化时 value 为 <code>undefined</code>，
<code>defineComputed(vm, key, userDef)</code> 即 <code>Object.defineProperty(target, key, sharedPropertyDefinition)</code>.
在 <code>sharedPropertyDefinition</code> 里会拿之前 watcher 过的依赖的值：</p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComputedGetter</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">computedGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers <span class="token operator">&&</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>所以 computed 中的值在读取的时候，拿到的结果即 watcher.value。</p>
<p><strong>总结下 data 响应式流程：</strong></p>
<p>this.xx 代理到 this._data.xx 然后 _data 在 Observer 里定义过 setter getter，在初始 render 时会收集依赖到闭包的 Dep 依赖实例的数组里，在 setter 时会通知所有依赖即每个 watcher 实例进行 update 更新。</p>
<p><strong>总结下 computed 响应式流程：</strong></p>
<p>this.xx 初始化时会先创建一个 watcher，然后通过 <code>Object.defineProperty</code> 进行 setter,getter 设置，其中 getter 会得到是 watcher.value 的值。</p>
<p><strong>注意：</strong></p>
<blockquote>
<p>Observer 文件下定义了个 <code>arrayMethods</code>，该方法重写了数组方法，使得改变 push 等操作也能触发更新。</p>
</blockquote>
<pre class="language-js"><code>methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// cache original method</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token comment">// notify change</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>附：
<a href="https://github.com/tanxchen/knowledge-note/blob/master/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/vuejs/mvvm.html#L1-L137">实现vue精简版响应式代码</a></p>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5ce411cb9ae55c41e3feed98" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5cdd790c9ae55c41e3feed97" data-v-98330b66>
        vue源码阅读之初始化过程
      </a></h1> <div class="post-meta" data-v-98330b66>2019-05-16 22:51:56</div> <div class="post-content mdcontent desc" data-v-98330b66><h3>import阶段</h3>
<p>从打包入口文件入手，<code>scripts/config.js</code>, ➡️ <code>resolve('web/entry-runtime.js')</code>
⤵️
入口文件 <code>src/platforms/entry-runtime.js</code>, <code>platforms</code> 文件夹是跟平台相关的代码
⤵️
<code>src/platforms/web/runtime/index.js</code>，<code>runtime/index.js</code> 里对该运行时代码做了特殊处理
⤵️
<code>src/code/index.js</code>,真正入口文件</p>
<pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'./instance/index'</span>
<span class="token comment">// ...</span>
<span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// ...ssr相关代码</span>
Vue<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'__VERSION__'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Vue
</code></pre>
<p>⤵️
<code>src/core/instance/index.js</code></p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加 _init 函数</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要是添加了 $data,$props,$watch,$set,$delete 几个属性和方法</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要是添加了 $on,$off,$once,$emit 三个方法</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要添加了 _update, $forceUpdate, $destroy 三个方法</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要添加了 $nextTick 和 _render 两个方法以及一大堆renderHelpers</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Vue
</code></pre>
<p><code>instance/index.js</code> 作用是按功能模块往 <code>Vue</code> 原型和自身添加了许多属性和方法。
再回到 <code>initGlobalAPI(Vue)</code>.</p>
<pre class="language-js"><code><span class="token comment">// 一般使用的是实例里的方法</span>
Vue<span class="token punctuation">.</span>set <span class="token operator">=</span> <span class="token keyword">set</span>
Vue<span class="token punctuation">.</span>delete <span class="token operator">=</span> del
Vue<span class="token punctuation">.</span>nextTick <span class="token operator">=</span> nextTick

Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">// 循环出来的结果其实是三个 `components`,`directives`, `filters`</span>
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// this is used to identify the "base" constructor to extend all plain-object</span>
<span class="token comment">// components with in Weex's multi-instance scenarios.</span>
Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue

<span class="token comment">// builtInComponents 仅为内置组件 KeepAlive</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span>

<span class="token function">initUse</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token comment">// 添加 Vue.use</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token comment">// 添加 Vue.mixin</span>
<span class="token function">initExtend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token comment">// 添加 Vue.extend</span>
<span class="token comment">// 添加 Vue.component, Vue.directive, Vue.filter 方法</span>
<span class="token function">initAssetRegisters</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
</code></pre>
<p><code>initGlobalAPI</code> 作用也是继续添加了一些全局方法。
现在 function Vue 大致就变成了如下样子：</p>
<pre class="language-js"><code><span class="token comment">//构造函数</span>
<span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//全局config对象，我们几乎不会用到</span>
Vue<span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token punctuation">{</span>
  keyCodes<span class="token punctuation">,</span>
  _lifecycleHooks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'beforeCreate'</span><span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 默认的options配置，我们每个组件都会继承这个配置。</span>
Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
  beforeCreate<span class="token punctuation">,</span> <span class="token comment">// 比如 vue-router 就会注册这个回调，因此会每一个组件继承</span>
  components<span class="token punctuation">,</span> <span class="token comment">// 前面提到了，默认组件有三个 `KeepAlive`,`transition`, `transitionGroup`，这里注册的组件就是全局组件，因为任何一个组件中不用声明就能用了。所以全局组件的原理就是这么简单</span>
  directives<span class="token punctuation">,</span> <span class="token comment">// 默认只有 `v-show` 和 `v-model`</span>
  filters
<span class="token punctuation">}</span>

<span class="token comment">//一些全局方法</span>
Vue<span class="token punctuation">.</span>use <span class="token comment">// 注册插件</span>
Vue<span class="token punctuation">.</span>component <span class="token comment">// 注册组件</span>
Vue<span class="token punctuation">.</span>directive <span class="token comment">// 注册指令</span>
Vue<span class="token punctuation">.</span>nextTick <span class="token comment">//下一个tick执行函数</span>
Vue<span class="token punctuation">.</span>set<span class="token operator">/</span><span class="token keyword">delete</span> <span class="token comment">// 数据的修改操作</span>
Vue<span class="token punctuation">.</span>mixin <span class="token comment">// 混入mixin用的</span>

<span class="token comment">//Vue.prototype 上有几种不同作用的方法</span>

<span class="token comment">//由initMixin 添加的 `_init` 方法，是Vue实例初始化的入口方法，会调用其他的功能初始话函数</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_init

<span class="token comment">// 由 initState 添加的三个用来进行数据操作的方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$data
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$props
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$watch
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$set
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token keyword">delete</span>

<span class="token comment">// 由initEvents添加的事件方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$on
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$off
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$one
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$emit

<span class="token comment">// 由 lifecycle添加的生命周期相关的方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_update
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$forceUpdate
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$destroy

<span class="token comment">//在 platform 中添加的生命周期方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount

<span class="token comment">// 由renderMixin添加的`$nextTick` 和 `_render` 以及一堆renderHelper</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$nextTick
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_render
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_b
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_e
<span class="token comment">//...</span>
</code></pre>
<h3>实例化阶段[new Vue({…})]</h3>
<p>代码在 <code>src/core/instance/init.js</code> 里。
主要功能代码：</p>
<ul>
<li>生成自增的唯一ID标识 <code>vm._uid = uid++</code></li>
<li>合并 <code>vm.constructor</code> 和传入的 <code>options</code>，生成 <code>vm.$options</code>
<ul>
<li>这一步使得可以在子组件能够使用全局的 directives、filters 等方法</li>
</ul>
</li>
<li>挂载自身 <code>vm._self = vm</code></li>
<li>初始化生命周期、事件、渲染等相关钩子工作
<ul>
<li>initLifecycle(vm)
<ul>
<li>定位第一个非抽象父级，并添加到 $children 里，<code>parent.$children.push(vm)</code></li>
<li>添加很多变量，主要为 $parent、$children，$refs 也在这里定义了，其他 <code>_</code>开头的变量均为生命周期不同阶段状态的 flag
<ul>
<li>vm.$parent = parent</li>
<li>vm.$root = parent ? parent.$root : vm</li>
<li>vm.$children = []</li>
<li>vm.$refs = {}</li>
<li>vm._watcher = null</li>
<li>vm._inactive = null</li>
<li>vm._directInactive = false</li>
<li>vm._isMounted = false</li>
<li>vm._isDestroyed = false</li>
<li>vm._isBeingDestroyed = false</li>
</ul>
</li>
</ul>
</li>
<li>initEvents(vm)
<ul>
<li>
<blockquote>
<p><strong>注册的是父组件事件</strong></p>
</blockquote>
</li>
</ul>
</li>
<li>initRender(vm)
<ul>
<li>做 render 的准备工作，并未开始 render，如创建 vm._vnode，vm.$createElement，$attrs 和 $listeners</li>
</ul>
</li>
<li>callHook(vm, ‘beforeCreate’)
<ul>
<li>调用 <code>beforeCreate</code> 生命周期钩子</li>
<li>
<blockquote>
<p>callHook 里定义了：<code>if (vm._hasHookEvent) {vm.$emit('hook:' + hook)}</code>，所以有个小技巧实现在在父组件通过 <code>hook</code> 钩子，监听子组件生命周期方法:</p>
</blockquote>
</li>
<li>
<pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Chind-Component</span> <span class="token attr-name"><span class="token namespace">@hook:</span>updated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>doSomething<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span> 
</code></pre>
</li>
</ul>
</li>
<li>initInjections(vm) // resolve injections before data/props</li>
<li>initState(vm)
<ul>
<li><code>data</code>, <code>props</code>, <code>computed</code> 等都是在这里初始化的，常见的面试考点比如<code>Vue是如何实现数据响应化的</code> 答案就在这个函数中寻找</li>
</ul>
</li>
<li>initProvide(vm) // resolve provide after data/props</li>
<li>callHook(vm, ‘created’)
<ul>
<li>调用 <code>created</code> 生命周期钩子</li>
</ul>
</li>
</ul>
</li>
<li>存在 el ,则调用 <code>$mount</code>，<code>vm.$mount(vm.$options.el)</code>
<ul>
<li>当然，el 也可以不写，而是在实例化的时候直接调用： <code>new Vue({...}).$mount('#app')</code></li>
</ul>
</li>
</ul>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5cdd790c9ae55c41e3feed97" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5cda85489ae55c41e3feed96" data-v-98330b66>
        koa中间件原理
      </a></h1> <div class="post-meta" data-v-98330b66>2019-05-14 17:07:20</div> <div class="post-content mdcontent desc" data-v-98330b66><p>koa 功能</p>
<ul>
<li>封装 http 模块【lib/application 下的 listen 方法】</li>
<li>构建中间件模型【通过 koa-compose 包】</li>
<li>整合了request,response,context【lib/application 下的 createContext 方法】</li>
<li>错误处理【lib/application 下的 onerror 方法】</li>
</ul>
<p>一个基础模板代码如下：</p>
<pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// logger</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rt <span class="token operator">=</span> ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// x-response-time</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>koa 里，中间件函数接收两个参数 context, next，
通过 use 方法，将函数添加到 <code>middleware</code> 数组里【 <code>this.middleware.push(fn)</code> 】，
在 listen 里</p>
<pre class="language-js"><code>http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>调用了 <code>callback</code>，在 <code>callback</code> 里，通过 <code>compose(this.middleware)</code>，
处理之前添加过的中间件，返回 <code>this.handleRequest(ctx, fn)</code> 来执行中间件，
<code>handleRequest</code> 是返回 Promise 函数的，所以在编写中间件时，往往通过 async await 来构建，这里主要来解析下 <code>compose</code>，它是引用了 <code>koa-compose</code> 包，主要源码如下：</p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compose</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// last called middleware</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      index <span class="token operator">=</span> i
      <span class="token keyword">let</span> fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> middleware<span class="token punctuation">.</span>length<span class="token punctuation">)</span> fn <span class="token operator">=</span> next
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>compose 里会返回 dispatch 方法，dispatch 里会先执行第一个fn，并将 middleware 队列里下一个 fn 作为 next 参数，且 dispatch 返回的为 Promise，从而形成了先进后出洋葱式模型。
<img src="https://gitee.com/tanxchen/img/raw/master/blog/koa-middleware.jpg" alt="koa-middleware"></p>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5cda85489ae55c41e3feed96" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5ccff6409ae55c41e3feed95" data-v-98330b66>
        Vuex源码分析
      </a></h1> <div class="post-meta" data-v-98330b66>2019-05-06 16:54:24</div> <div class="post-content mdcontent desc" data-v-98330b66><p>Vuex是Vue的数据状态管理插件.将数据放在单例下的store里，对数据进行监控管理.</p>
<h3>引入、安装阶段，从入口 index.js开始</h3>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  Store<span class="token punctuation">,</span>
  install<span class="token punctuation">,</span>
  version<span class="token operator">:</span> <span class="token string">'__VERSION__'</span><span class="token punctuation">,</span>
  mapState<span class="token punctuation">,</span>
  mapMutations<span class="token punctuation">,</span>
  mapGetters<span class="token punctuation">,</span>
  mapActions<span class="token punctuation">,</span>
  createNamespacedHelpers
<span class="token punctuation">}</span>
</code></pre>
<p>导出了 Store 类和一些辅助map开头的函数。
最初在项目里使用Vuex时，<code>Vue.use(Vuex)</code>里便是调用了<code>install</code>方法。</p>
<pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">let</span> Vue
<span class="token comment">// ...</span>
<span class="token comment">// 初始install阶段，Vue.use(Vuex)会调用install方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">_Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Vue为store里定义，_Vue为调用install时传入的Vue</span>
  <span class="token comment">// 防止重复install</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Vue <span class="token operator">&&</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
        <span class="token string">'[vuex] already installed. Vue.use(Vuex) should be called only once.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  Vue <span class="token operator">=</span> _Vue
  <span class="token comment">// applyMixin函数作用：将store注入到子组件，子组件可通过this.$store访问store</span>
  <span class="token function">applyMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>store.js里导出了<code>install</code>方法。在store.js开头定义局部 Vue 变量，用于判断是否已经装载和减少全局作用域查找。
这里调用<code>applyMixin</code>方法，它将store注入到子组件，子组件可通过this.$store访问store
<code>// applyMixin.js</code></p>
<pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> beforeCreate<span class="token operator">:</span> vuexInit <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre>
<p>applyMixin里对 vue 1.0 和 2.0 版本进行了判断，2.0下在<code>beforeCreate</code>阶段注入<code>store</code></p>
<pre class="language-js"><code><span class="token comment">// 子组件可以通过this.$store来访问store</span>
<span class="token keyword">function</span> <span class="token function">vuexInit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options
  <span class="token comment">// 注入store</span>
  <span class="token comment">// 初始时，在根组件上，调用者会传入store，所以会进入if逻辑</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// options上的store可以为 function，</span>
    <span class="token comment">// 这类似于 vue 里的 data return 的是个 function，防止多个 store下，里面的数据被共享</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>store <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> options<span class="token punctuation">.</span>store
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>parent <span class="token operator">&&</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在子组件上，初始化时未传入store，则从父组件中获取store</span>
    <span class="token comment">// 公用了一份初始根组件时传入的全局的store</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3>new Store实例化阶段</h3>
<pre class="language-js"><code>  <span class="token comment">// plugins为外部传入的插件</span>
  <span class="token comment">// strict为默认不开启严格模式（严格模式：只能在mutation里进行数据更改，在action等其他位置进行数据更改会抛出错误）</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    strict <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> options

  <span class="token comment">// 定义store 内部状态</span>
  <span class="token comment">// 用于判断是否在commit环节的flag，保证只在mutation环境改变state</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token comment">// actions操作对象</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 发布订阅模式下的订阅函数集合</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// mutations操作对象</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_mutations <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 封装后的getters集合对象</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_wrappedGetters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">/**
   * 格式化 options，也是该源码阅读的核心重点，
   * 在非模块模式（普通用法传入options）或 在按模块开发方式传入store时，存储处理过的modules
   * this._modules = {
   *   root: {
   *     context: {dispatch: ƒ, commit: ƒ},
   *     runtime: false,
   *     state: {…},
   *     _children: {},
   *     _rawModule: {state: {…}, actions: {…}, mutations: {…}, plugins: Array(1)},
   *     namespaced: false
   *   },
   *   __proto__: {
   *    get: ƒ (path)
   *    getNamespace: ƒ getNamespace(path)
   *    register: ƒ register(path, rawModule, runtime)
   *    unregister: ƒ unregister(path)
   *    update: ƒ update$1(rawRootModule)
   *    constructor: ƒ ModuleCollection(rawRootModule)
   *    __proto__: {...}
   *   }
   * }
   */</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleCollection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
  <span class="token comment">// 模块命名空间map</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_modulesNamespaceMap <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 发布订阅模式下的订阅函数集合</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_subscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// vue实例，用到watch监视变化功能</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_watcherVM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
  <span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">)</span>

  <span class="token comment">// initialize the store vm, which is responsible for the reactivity</span>
  <span class="token comment">// (also registers _wrappedGetters as computed properties)</span>
  <span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>

  <span class="token comment">// 调用传入的各种插件</span>
  plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">plugin</span> <span class="token operator">=></span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> useDevtools <span class="token operator">=</span> options<span class="token punctuation">.</span>devtools <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>devtools <span class="token operator">:</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>devtools
  <span class="token keyword">if</span> <span class="token punctuation">(</span>useDevtools<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">devtoolPlugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre>
<p>在 <code>constructor</code> 里主要操作为： 格式化modules，安装 module，初始化 store vm, 安装 plugins</p>
<h3>格式化modules，即 <code>this._modules = new ModuleCollection(options)</code></h3>
<p>由于使用单一状态树，应用的所有状态会集中到一个比较大的对象。当应用变得非常复杂时，store 对象就有可能变得相当臃肿。</p>
<p>为了解决以上问题，Vuex 允许我们将 store 分割成模块（module）。
每个模块拥有自己的 state、mutation、action、getter、甚至是嵌套子模块——从上至下进行同样方式的分割：</p>
<pre class="language-js"><code><span class="token keyword">const</span> moduleA <span class="token operator">=</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> moduleB <span class="token operator">=</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  modules<span class="token operator">:</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> moduleA<span class="token punctuation">,</span>
    b<span class="token operator">:</span> moduleB
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>代码被分割到 <code>./module/module-collection</code> 文件夹下。
初始化时，执行 <code>register</code> 方法</p>
<pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rawRootModule<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre>
<p>register 接收3个参数</p>
<ul>
<li>path：路径，模块tree的路径</li>
<li>rawModule：最初 <code>new Store</code> 时传入的 <code>options</code></li>
<li>runtime：是否是运行时创建的模块,在初始化根模块时为 false， 其他情况为 true，理解为 初始化时的 flag</li>
</ul>
<p>如初始化 register 时，参数为：<code>path: [], rawModule: options, runtime: false</code></p>
<pre class="language-js"><code><span class="token function">register</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> rawModule<span class="token punctuation">,</span> runtime <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// path: [], rawModule: options, runtime: false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对构造器传入的options的getters、mutations、actions进行dev环境的格式校验</span>
    <span class="token comment">// 非预期的格式会抛出错误</span>
    <span class="token function">assertRawModule</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> rawModule<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 初始化module</span>
  <span class="token keyword">const</span> newModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
  <span class="token comment">// 第一次初始化时，执行if代码块，path为[]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> newModule
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前module的parent</span>
    <span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 添加child</span>
    parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 递归注册嵌套的module</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">forEachValue</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">rawChildModule<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> rawChildModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>register 里的逻辑大致为</p>
<ul>
<li>校验传入的options格式，非预期的格式会抛出错误</li>
<li>实例化 <code>Module</code>，初始化时 模块 tree 的根即为 root，之后 addChild 添加的子模块 即会放入到 root._children 里，逐级对包含的所以模块进行递归 register，以形式 模块 tree</li>
</ul>
<p>root格式如下：</p>
<pre class="language-js"><code>root<span class="token operator">:</span> <span class="token punctuation">{</span>
  context<span class="token operator">:</span> <span class="token punctuation">{</span>dispatch<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> commit<span class="token operator">:</span> ƒ<span class="token punctuation">}</span><span class="token punctuation">,</span>
  runtime<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span>
  _children<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  _rawModule<span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> actions<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> mutations<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> plugins<span class="token operator">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  namespaced<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre>
<h4>初始化module</h4>
<pre class="language-js"><code><span class="token comment">// 初始化module</span>
<span class="token keyword">const</span> newModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
</code></pre>
<p>Module 定义在 <code>./module/module.js</code> 里</p>
<p>构造函数：</p>
<pre class="language-js"><code><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">rawModule<span class="token punctuation">,</span> runtime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// rawModule: options, runtime: false</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>runtime <span class="token operator">=</span> runtime
  <span class="token comment">// 存储module子项</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 存储初始化时传入的原始options</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule <span class="token operator">=</span> rawModule
  <span class="token keyword">const</span> rawState <span class="token operator">=</span> rawModule<span class="token punctuation">.</span>state

  <span class="token comment">// 兼容module形式里state传入函数形式，类似 组件中的 data，总是return 一个Object，来防止对象被共享</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> rawState <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">rawState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> rawState<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>屡下 模块初始化 思路：</p>
<ul>
<li>对初始传入的 options 进行模块 实例化，</li>
<li>里面包含了子模块的话 会被递归 放进 root._children 对象里，形成一颗 模块 tree，</li>
<li>并且 通过 <code>forEachMutation</code> 包装函数等的类似方法，子模块在执行 action、mutation 方法时也只是执行的是子模块里对应的方法，</li>
<li>每个模块的 _rawModule 即为 定义时 传入的 options</li>
<li>每个模块的 state 即为 定义时 传入的 options.state</li>
</ul>
<h3>安装模块</h3>
<pre class="language-js"><code><span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
</code></pre>
<p>在模块被初始化定义后，通过 installModule 对 state, actions, mutations, getters 进行初始化处理。</p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">installModule</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">,</span> module<span class="token punctuation">,</span> hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// this, state(this._modules.root.state), [], this._modules.root</span>
  <span class="token comment">// 是root时，path为[]</span>
  <span class="token keyword">const</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>length
  <span class="token comment">//  modules: {</span>
  <span class="token comment">//     a: moduleA,</span>
  <span class="token comment">//     b: moduleB</span>
  <span class="token comment">//   }</span>
  <span class="token comment">// modules.a 的命名空间为 'a/'</span>
  <span class="token keyword">const</span> namespace <span class="token operator">=</span> store<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>

  <span class="token comment">// 存储namespace对应的module于_modulesNamespaceMap</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> module
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置 state</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&&</span> <span class="token operator">!</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> parentState <span class="token operator">=</span> <span class="token function">getNestedState</span><span class="token punctuation">(</span>rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> moduleName <span class="token operator">=</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    store<span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parentState<span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> module<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> local <span class="token operator">=</span> module<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">makeLocalContext</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span>

  <span class="token comment">// 拼接namespace，如：</span>
  <span class="token comment">// modules: {</span>
  <span class="token comment">//   account: {</span>
  <span class="token comment">//     namespaced: true,</span>
  <span class="token comment">//     state: { ... }, // 模块内的状态已经是嵌套的了，使用 `namespaced` 属性不会对其产生影响</span>
  <span class="token comment">//     getters: {</span>
  <span class="token comment">//       isAdmin () { ... } // -> getters['account/isAdmin']</span>
  <span class="token comment">//     },</span>
  <span class="token comment">//     actions: {</span>
  <span class="token comment">//       login () { ... } // -> dispatch('account/login')</span>
  <span class="token comment">//     },</span>
  <span class="token comment">//     mutations: {</span>
  <span class="token comment">//       login () { ... } // -> commit('account/login')</span>
  <span class="token comment">//     }</span>
  <span class="token comment">//   }</span>
  <span class="token comment">// }</span>
  module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key
    <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  module<span class="token punctuation">.</span><span class="token function">forEachAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> type <span class="token operator">=</span> action<span class="token punctuation">.</span>root <span class="token operator">?</span> key <span class="token operator">:</span> namespace <span class="token operator">+</span> key
    <span class="token keyword">const</span> handler <span class="token operator">=</span> action<span class="token punctuation">.</span>handler <span class="token operator">||</span> action
    <span class="token function">registerAction</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  module<span class="token punctuation">.</span><span class="token function">forEachGetter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">getter<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key
    <span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> getter<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 递归install子项</span>
  module<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> hot<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4>分析下 registerMutation 的注册</h4>
<p>在这里先通过 forEachMutation 方法, 传入对应的模块的 mutation 和 key，
registerMutation 里将我们项目里定义的 mutations 方法以 key-value 形式存入 _mutations 里，在传入的时候 将 state 作为第一参数，我们自己传入的为第二参数形式，这里使得如文档里所说一样形式使用：</p>
<pre class="language-js"><code><span class="token comment">// ...</span>
mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token function">increment</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>count <span class="token operator">+=</span> payload<span class="token punctuation">.</span>amount
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>这里会对命名空间进行处理，假如模块 A 中有名为 add 的 mutation 函数，那么在注册过程中会变成 a/add</p>
</blockquote>
<p>相关 Mutation 注册代码：
->>>>>>>>>>>></p>
<pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key
  <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//</span>
<span class="token function">forEachMutation</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule<span class="token punctuation">.</span>mutations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">forEachValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule<span class="token punctuation">.</span>mutations<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//</span>
<span class="token keyword">function</span> <span class="token function">registerMutation</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">wrappedMutationHandler</span> <span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</p>
<h4>registerAction 的注册</h4>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">registerAction</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">wrappedActionHandler</span> <span class="token punctuation">(</span><span class="token parameter">payload<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      dispatch<span class="token operator">:</span> local<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span>
      commit<span class="token operator">:</span> local<span class="token punctuation">.</span>commit<span class="token punctuation">,</span>
      getters<span class="token operator">:</span> local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>
      state<span class="token operator">:</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
      rootGetters<span class="token operator">:</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>
      rootState<span class="token operator">:</span> store<span class="token punctuation">.</span>state
    <span class="token punctuation">}</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> cb<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'vuex:error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> err
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里将 <code>{ dispatch commit getters state rootGetters rootState }</code> 作为第一参数，将自己dispatch 时传入的参数作为第二参数，所以有了文档里所说的书写形式：</p>
<pre class="language-js"><code><span class="token comment">// 自己项目里的 actions.js</span>
<span class="token function">toggleMenu</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'TOGGLE_MENU'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// or</span>
<span class="token function">setSidebarMenuList</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> userType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_SIDEBAR_MENU_LIST'</span><span class="token punctuation">,</span> userType<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>registerAction 里 处理了 promise 情况，所以 store.dispatch 可以处理被触发的 action 的处理函数返回的 Promise，并且 store.dispatch 仍旧返回 Promise</p>
</blockquote>
<p>所以我们可以这么来写：</p>
<pre class="language-js"><code><span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'auth_request'</span><span class="token punctuation">)</span>
    <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>url<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> user<span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>token
        <span class="token keyword">const</span> user <span class="token operator">=</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
        axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>common<span class="token punctuation">[</span><span class="token string">'Authorization'</span><span class="token punctuation">]</span> <span class="token operator">=</span> token
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'auth_success'</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'auth_error'</span><span class="token punctuation">)</span>
        localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">register</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>将处理的请求提取到了vuex里，也使得页面里代码更加简洁了。只保留了业务逻辑。</p>
<h4>registerGetter 的注册</h4>
<pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">return</span> <span class="token function">rawGetter</span><span class="token punctuation">(</span>
  local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment">// local state</span>
  local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> <span class="token comment">// local getters</span>
  store<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment">// root state</span>
  store<span class="token punctuation">.</span>getters <span class="token comment">// root getters</span>
<span class="token punctuation">)</span>
</code></pre>
<p>getter 这里先处理了命名空间，然后这里接收 4 个参数。
前面两个为模块内的 local state ，local getters，后两个参数为根节点上的内容 root state，root getters。
当然，没使用模块形式的话，两者相同。</p>
<h3>resetStoreVM(this, state)</h3>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resetStoreVM</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldVm <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm

  <span class="token comment">// bind store public getters</span>
  store<span class="token punctuation">.</span>getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> wrappedGetters <span class="token operator">=</span> store<span class="token punctuation">.</span>_wrappedGetters
  <span class="token keyword">const</span> computed <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">forEachValue</span><span class="token punctuation">(</span>wrappedGetters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// use computed to leverage its lazy-caching mechanism</span>
    computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
      enumerable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// for local getters</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// ...</span>
  store<span class="token punctuation">.</span>_vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
      $$state<span class="token operator">:</span> state
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    computed
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>resetStoreVM 的工作是 实例化一个 vue 实例，并将 getters 里定义的方法 通过 Object.defineProperty 来进行绑定到 store.getters 上，
并作为 computed 计算属性，在state变化时，getter 能响应式变化。
在实际调用 即为如下关系：</p>
<pre class="language-js"><code><span class="token comment">// 这里使得vm.$store.state 取到 vm._data.$$state</span>
<span class="token keyword">get</span> <span class="token function">state</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-js"><code>store<span class="token punctuation">.</span>state <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>a <span class="token operator">=</span> store<span class="token punctuation">.</span>a <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state<span class="token punctuation">.</span>a
</code></pre>
<p>Vuex 还有一些map开头的辅助函数，这些 handler 通过 hook 达到了简写的目的。
Vuex 本身是 Vue 的插件形式，其自身继续延续支持插件形式。<code>replaceState</code>,<code>subscribe</code>通常会在插件里用到。</p>
<pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>payload<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5ccff6409ae55c41e3feed95" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5c4b2ef6425f444b816c7a18" data-v-98330b66>
        浏览器相关知识点
      </a></h1> <div class="post-meta" data-v-98330b66>2019-01-25 23:44:55</div> <div class="post-content mdcontent desc" data-v-98330b66><h3>浏览器输入url到看到页面的流程</h3>
<ul>
<li>DNS解析
<ul>
<li>DNS服务器对域名解析，得到目标服务器的IP后，进行HTTP访问</li>
</ul>
</li>
<li>↓</li>
<li>应用层【HTTP数据】</li>
<li>↓</li>
<li>传输层【TCP协议：确保可靠性】
<ul>
<li>为了传输方便，在传输层（TCP 协议）把从应用层处收到的数据（HTTP 请求报文）进行分割，并在各个报文上打上标记序号及端口号后转发给网络层。</li>
<li>三次握手🤝
<ul>
<li>握手过程中使用了TCP的标志 [flag] —— SYN [synchronize] 和 ACK [acknowledgement]
<ul>
<li>发送端首先发送一个带 SYN 标志的数据包给对方。</li>
<li>接收端收到后，回传一个带有 SYN/ACK 标志的数据包以示传达确认信息。</li>
<li>最后，发送端再回传一个带 ACK 标志的数据包，代表“握手”结束。若在握手过程中某个阶段莫名中断，TCP 协议会再次以相同的顺序发送相同的数据包。<br><img src="https://gitee.com/tanxchen/img/raw/master/blog/tcp-3-call.jpg" width="420px" height="280px"></li>
</ul>
</li>
</ul>
</li>
<li>除了上述三次握手，TCP 协议还有其他各种手段来保证通信的可靠性</li>
</ul>
</li>
<li>↓</li>
<li>网络层【IP协议：负责传输、ARP协议：地址解析协议】
<ul>
<li>增加作为通信目的地的 MAC 地址</li>
<li>ARP 是一种用以解析地址的协议，根据通信方的 IP 地址就可以反查出对应的 MAC 地址</li>
</ul>
</li>
<li>↓</li>
<li>数据链路层</li>
<li>↓</li>
<li>服务器
<ul>
<li>数据链路层接收，按序往上层发送，并把对应的首部消去，TCP按序重组请求报文，HTTP处理请求，返回响应</li>
</ul>
</li>
<li>↓</li>
<li>处理请求，返回响应内容</li>
<li>↓</li>
<li>浏览器得到资源内容/报文，进行解析渲染
<ul>
<li>检查HTML并构建DOM
<ul>
<li>字节 -> 字符串 -> node -> DOM</li>
</ul>
</li>
<li>检查CSS并构建CSSOM【CSS Object Model，是一个建立在web页面上的 CSS 样式的映射】
<ul>
<li>字节 -> 字符串 -> node -> DOM</li>
</ul>
</li>
<li>Web浏览器将DOM和CSSOM结合，并构建出渲染树（render tree）
<ul>
<li>包含节点和节点样式信息</li>
</ul>
</li>
<li>渲染引擎根据 RenderTree 开始渲染和展示
<ul>
<li>布局（回流）：确定节点位置和大小</li>
<li>绘制：调用CPU，合成图层，显示与屏幕</li>
</ul>
</li>
<li>遇到 script、link 会阻塞</li>
</ul>
</li>
<li>断开连接，四次挥手👋<br>
<img src="https://gitee.com/tanxchen/img/raw/master/blog/http-tcp.jpg" width="450px" height="450px">
<br></li>
</ul>
<hr>
<br>
<img src="https://gitee.com/tanxchen/img/raw/master/blog/all.jpg" width="500px" height="700px">
<h3>协议对应OSI七层模型位置：</h3>
<ul>
<li>物理层</li>
<li>数据链路层</li>
<li>网络层
<ul>
<li>IP</li>
</ul>
</li>
<li>传输层
<ul>
<li>TCP</li>
<li>UDP(User Data Protocal): 用户数据报协议
<ul>
<li>不可靠，可能丢包而且包的顺序性也不能保证</li>
</ul>
</li>
</ul>
</li>
<li>会话层</li>
<li>表示层</li>
<li>应用层
<ul>
<li>http</li>
</ul>
</li>
</ul>
<h3>重绘、回流有什么区别？</h3>
<ul>
<li>网页生成时，至少会渲染一次，在用户访问过程中，还会不断重新渲染</li>
<li>重绘是当节点需要更改外观而不影响布局，如：color的改变</li>
<li>回流是布局或者几何属性的改变，如：width、height的改变</li>
<li>回流必定发生重绘，重绘未必引发回流</li>
</ul>
<h3>async 和 defer 有什么区别？</h3>
<ul>
<li>async 如果已经加载好，就会开始执行</li>
<li>defer 不阻塞 HTML 的解析，HTML解析完后，再执行</li>
<li>加载多个JS脚本，async无序加载，而defer有序加载
<ul>
<li>如加载 谷歌统计代码，使用async</li>
<li>加载 JS相互依赖代码，使用defer，如 jQuery.js、jQuery-plugin.js</li>
</ul>
</li>
</ul>
<h3>为什么操作DOM慢？</h3>
<ul>
<li>相当于不同线程之间的通信</li>
<li>可能带来重绘、回流</li>
</ul>
<h3>强缓存和协商缓存</h3>
<blockquote>
<p>强缓存是不经过服务器的, 协商缓存是经过服务器的</p>
</blockquote>
<blockquote>
<p>强缓存可能从本地内存获取，也可能从本地磁盘内读取</p>
</blockquote>
<ul>
<li>强缓存相关字段(Expires(响应头), Cache-Control(响应头)),
<blockquote>
<p>Cache-Control优先级大于Expires</p>
</blockquote>
<ul>
<li>Cache-Control
<ul>
<li>no-cache：强制向源服务器再次验证</li>
<li>no-store：不缓存请求或响应的任何内容，<strong>这才是真的’no-cache’不缓存</strong></li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li>协商缓存相关字段(Last-Modified(响应头), If-Modified-Since(请求头), Etag(响应头), If-None-Match(请求头))</li>
</ul>
<p>HTTP 缓存机制流程图:</p>
<p><img src="https://gitee.com/tanxchen/img/raw/master/blog/cache.jpeg" alt="catch"></p>
<h3>为什么建立连接是三次握手，而关闭连接却是四次挥手呢？</h3>
<hr>
<p><a href="https://book.douban.com/subject/25863515/">参考-图解HTTP</a><br>
<a href="https://varvy.com/performance/cssom.html">参考-Introduction to the CSS Object Model</a><br>
<a href="https://juejin.im/post/5c24d736f265da614b120d4a">参考-掘金文章-深入浅出浏览器渲染原理</a><br>
<a href="https://juejin.im/post/5a0444d45188255ea95b66bc">参考-掘金文章-TCP的三次握手四次挥手</a><br>
<a href="https://segmentfault.com/a/1190000017184701">参考-segmentfault文章-从URL输入到页面展现到底发生什么？</a><br>
<a href="https://github.com/MuYunyun/blog/blob/master/BasicSkill/http/http.md">参考-github.com/MuYunyun/blog</a></p>
<p>ARP协议相关资料：<a href="https://baike.baidu.com/item/ARP/609343">ARP协议百度百科</a></p>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5c4b2ef6425f444b816c7a18" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5c4672b79f894d0f47f5f53c" data-v-98330b66>
        已知年月，求该月共多少天？
      </a></h1> <div class="post-meta" data-v-98330b66>2019-01-22 09:32:39</div> <div class="post-content mdcontent desc" data-v-98330b66><p>在写日历组件时，曾遇到 <strong>已知年月，求该月共多少天？</strong> 这样的需求。</p>
<p>最开始思路会是：</p>
<ul>
<li>先判断该年份是否是闰年，来处理 2 月份情况，闰年 2 月共 29 天，非闰年 2 月共 28 天</li>
<li>再判断其他月份，如 1 月共 31 天，4 月共 30 天</li>
</ul>
<p>代码就不一一列出了，思路代码啥的没啥问题。</p>
<p>这里其实有种更简便的方法，借助 <code>Date</code> API 处理日期溢出时，会自动往后推延响应时间的规则，直接上代码：</p>
<pre class="language-js"><code><span class="token comment">// month 值需对应实际月份减一，如实际 2 月，month 为 1，实际 3 月，month 为 2</span>
<span class="token keyword">function</span> <span class="token function">getMonthCountDay</span> <span class="token punctuation">(</span><span class="token parameter">year<span class="token punctuation">,</span> month</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">32</span> <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>验证下：</p>
<pre class="language-js"><code><span class="token comment">// 求闰年的 2 月份总天数</span>
<span class="token function">getMonthCountDay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 29</span>
<span class="token comment">// 求非闰年的 2 月份总天数</span>
<span class="token function">getMonthCountDay</span><span class="token punctuation">(</span><span class="token number">2001</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 28</span>
<span class="token comment">// 求 1 月份总天数</span>
<span class="token function">getMonthCountDay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 31</span>
<span class="token function">getMonthCountDay</span><span class="token punctuation">(</span><span class="token number">2001</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 31</span>
<span class="token comment">// 求 4 月份总天数</span>
<span class="token function">getMonthCountDay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 30</span>
<span class="token function">getMonthCountDay</span><span class="token punctuation">(</span><span class="token number">2001</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 30</span>
</code></pre>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5c4672b79f894d0f47f5f53c" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5c45d9fe9f894d0f47f5f53b" data-v-98330b66>
        CSS里的BFC
      </a></h1> <div class="post-meta" data-v-98330b66>2019-01-21 22:41:02</div> <div class="post-content mdcontent desc" data-v-98330b66><h2>BFC概念</h2>
<p>块格式化上下文（Block Formatting Context，BFC） 是Web页面的可视化CSS渲染的一部分，是布局过程中生成块级盒子的区域，也是浮动元素与其他元素的交互限定区域。是CSS2.1规范定义的内容。</p>
<p><strong>下列方式会创建块格式化上下文：</strong></p>
<ul>
<li>根元素或包含根元素的元素</li>
<li>浮动元素（元素的 <code>float</code> 不是 <code>none</code>）</li>
<li>绝对定位元素（元素的 <code>position</code> 为 <code>absolute</code> 或 <code>fixed</code>）</li>
<li>行内块元素（元素的 <code>display</code> 为 <code>inline-block</code>）</li>
<li>表格单元格（元素的 <code>display</code>为 <code>table-cell</code>，HTML表格单元格默认为该值）</li>
<li>表格标题（元素的 <code>display</code> 为 <code>table-caption</code>，HTML表格标题默认为该值）</li>
<li>匿名表格单元格元素（元素的 <code>display</code>为 <code>table</code>、<code>table-row</code>、 <code>table-row-group</code>、t<code>able-header-group</code>、<code>table-footer-group</code>（分别是HTML table、row、tbody、thead、tfoot的默认属性）或 <code>inline-table</code>）</li>
<li>overflow 值不为 <code>visible</code> 的块元素</li>
<li>display 值为 <code>flow-root</code> 的元素</li>
<li>contain 值为 <code>layout</code>、<code>content</code>或 <code>strict</code> 的元素</li>
<li>弹性元素（<code>display</code>为 <code>flex</code> 或 <code>inline-flex</code>元素的直接子元素）</li>
<li>网格元素（<code>display为</code> <code>grid</code> 或 <code>inline-grid</code> 元素的直接子元素）</li>
<li>多列容器（元素的 <code>column-count</code> 或 <code>column-width</code> 不为 <code>auto</code>，包括 <code>column-count</code> 为 1）</li>
<li><code>column-span</code> 为 <code>all</code> 的元素始终会创建一个新的BFC，即使该元素没有包裹在一个多列容器中（标准变更，Chrome bug）。</li>
</ul>
<p><em>块格式化上下文包含创建它的元素内部的所有内容.</em></p>
<blockquote>
<p>根元素即为一个BFC</p>
</blockquote>
<h3>特性</h3>
<ul>
<li>属于同一个BFC的两个相邻Box的margin会发生重叠，与方向无关，仅保留较大的margin值</li>
<li>消除与浮动元素的重叠</li>
<li>可制造内部浮动（计算BFC的高度时，浮动子元素也参与计算）</li>
<li>每个元素的margin-left，与包含块border-left相接触(对于从左往右的格式化，否则相反)。即使存在浮动也是如此（见demo里的part3）。</li>
</ul>
<h3>demo</h3>
<p><a href="https://codepen.io/tanxchen/pen/OdLbwq">demo</a></p>
<h3>总结</h3>
<p>BFC是文档内元素显示的一种形式，概念有点抽象,可想像成在文档里为一个密闭的空间，与外部进行了隔离。在默认情况下，根元素即为BFC。所以在根元素内部的元素垂直方向会产生margin重合，浮动元素会产生元素重叠，BFC可消除元素内的子元素浮动产生的不包含情况等特性。</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Block_formatting_context">参考MDN链接</a></p>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5c45d9fe9f894d0f47f5f53b" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5c376a7c9f894d0f47f5f53a" data-v-98330b66>
        简单实现浅拷贝与深拷贝
      </a></h1> <div class="post-meta" data-v-98330b66>2019-01-10 23:53:32</div> <div class="post-content mdcontent desc" data-v-98330b66><h3>深浅拷贝区别</h3>
<p>浅拷贝只复制第一层可枚举的属性值，深拷贝对每一层里的可枚举的属性值都进行复制。</p>
<ul>
<li>
<h3>简单实现浅拷贝</h3>
</li>
</ul>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">copy</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> source <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span>
  <span class="token keyword">const</span> copy <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    copy<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> copy
<span class="token punctuation">}</span>
</code></pre>
<p>浅拷贝的实现有</p>
<ul>
<li><code>Object.assign</code></li>
<li><code>...</code>展开语法</li>
<li><code>Array.prototype.slice()</code></li>
<li>数组的<code>concat</code></li>
</ul>
<ul>
<li>
<h3>简单实现深拷贝</h3>
</li>
</ul>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepCopy</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> source <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> source<span class="token punctuation">;</span>
  <span class="token keyword">const</span> copy <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    copy<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span>source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> copy
<span class="token punctuation">}</span>
</code></pre>
<p><code>JSON.parse(JSON.stringify(source))</code> 是对深拷贝的实现</p>
<p>但存在如下问题：</p>
<ul>
<li>拷贝JSON中不支持的类型会有问题，如<code>Date</code>类型拷贝时，会转化为带T格式的日期字符串</li>
</ul>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5c376a7c9f894d0f47f5f53a" data-v-98330b66>阅读全文</a></p></div><div class="post" data-v-98330b66><h1 class="post-title" data-v-98330b66><a href="/blog/article/5c2a1441b042777d45a5859d" data-v-98330b66>
        Centos6.8下安装jenkins
      </a></h1> <div class="post-meta" data-v-98330b66>2018-12-31 21:06:09</div> <div class="post-content mdcontent desc" data-v-98330b66><p>本博客使用了jenkins进行持续集成，在配置腾讯云时，顺便记录下配置过程。安装jenkins的方式<a href="https://jenkins.io/doc/book/installing/">官网</a> 给出了多种，这里使用了war包文件方式安装。</p>
<h2>一、安装前提</h2>
<h3>1、安装java1.8版本</h3>
<p>Jenkins 依赖于1.8版本的java。</p>
<p>使用yum，安装java1.8，执行</p>
<pre class="language-text"><code>yum install -y java-1.8.0-openjdk.x86_64
</code></pre>
<p>安装以后执行 <code>java -version</code> 看下是否安装成功。</p>
<h3>2、添加环境变量</h3>
<p>接着在 /etc/profile文件里添加java的环境变量</p>
<pre class="language-text"><code>vim  /etc/profile
</code></pre>
<p>在最后添加如下代码：</p>
<pre class="language-text"><code>JAVA_HOME=/usr/java/jdk1.8.0_74
JRE_HOME=/usr/java/jdk1.8.0_74/jre
PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin
CLASSPATH=:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib
</code></pre>
<p>执行修改生效命令：<code>source /etc/profile</code></p>
<p>查看是否生效命令：<code>echo $PATH</code></p>
<h2>二、jenkins相关</h2>
<h3>1、下载jenkins war包</h3>
<p>java安装的准备工作做完了，接着根据<a href="https://pkg.jenkins.io/redhat/">官网</a>提供的Centos下的jenkins下载方式，执行如下命令：</p>
<pre class="language-text"><code>sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat/jenkins.repo
sudo rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key
</code></pre>
<p>找到刚下载的安装包，可执行如下命令：</p>
<p><code>rpm -ql jenkins</code></p>
<p>结果如下：</p>
<pre class="language-text"><code>[root@VM_160_98_centos ~]# rpm -ql jenkins
/etc/init.d/jenkins
/etc/logrotate.d/jenkins
/etc/sysconfig/jenkins
/usr/lib/jenkins
/usr/lib/jenkins/jenkins.war
/usr/sbin/rcjenkins
/var/cache/jenkins
/var/lib/jenkins
/var/log/jenkins
</code></pre>
<p><code>/usr/lib/jenkins/jenkins.war</code>就是war包的位置了。</p>
<h3>2、默认启动端口</h3>
<p>这里先顺便修改下jenkins的8080默认启动端口。(查看端口使用情况命令：<code>netstat -ntlp</code>)</p>
<p>修改端口的文件命令为：<code>vim /etc/sysconfig/jenkins</code>，找到里面的<code>JENKINS_PORT="8080"</code>，我这里改为了5555，没需求可不修改。</p>
<h3>3、运行jenkins</h3>
<p>运行jenkins命令且退出命令行不影响程序执行，运行如下命令：</p>
<p><code>java -jar /usr/lib/jenkins/jenkins.war --httpPort=5555 &</code></p>
<p>其中 <code>&</code> 符号使得退出命令行不影响程序执行。</p>
<h3>4、添加nginx 代理端口设置</h3>
<p>接着在nginx里配置代理到5555端口，使得外网能访问。</p>
<p>接着到服务器后台管理（我服务器是腾讯云）添加子域名和在安全组里添加5555端口的入站规则。</p>
<p>这样jenkins就算安装完成了。<a href="http://jenkins.tanxchen.com">http://jenkins.tanxchen.com</a></p>
<h2>附：Jenkins 默认插件</h2>
<p><img src="https://gitee.com/tanxchen/img/raw/master/blog/jenkins-default-plugin-ls.jpg" alt="默认插件"></p>
<ul>
<li>Floders Plugin</li>
<li>OWASP markup formatter plugin</li>
<li>Build timeout plugin</li>
<li>Credentials binding plugin</li>
<li>timestamper</li>
<li>Workspace cleanup plugin</li>
<li>ant plugin</li>
<li>Gradle plugin</li>
<li>pipeline</li>
<li>Github organization floder plugin</li>
<li>pipeline stage view plugin</li>
<li>Git plugin</li>
<li>subversion plugin</li>
<li>SSH slaves plugin</li>
<li>Matrix authorization stragegy plugin</li>
<li>PAM authentication plugin</li>
<li>LDAP plugin</li>
<li>Email extension plugin</li>
<li>Mailer plugin</li>
</ul>
<p>共19个默认插件</p>
</div> <p class="readmore" data-v-98330b66><a href="/blog/article/5c2a1441b042777d45a5859d" data-v-98330b66>阅读全文</a></p></div></section> <footer class="bl-footer" style="position:relative;margin-top:-60px"><div class="footer-wrap"><div style="text-align:center">
      2018-present © by <a href="#" target="_blank">TanxChen</a> All Rights Reserved. <a href="http://www.miitbeian.gov.cn" target="_blank">浙ICP备18014267号-1</a></div></div></footer></div></div></div><script defer src="/blog/_nuxt/static/1636300541/state.js"></script><script src="/blog/_nuxt/b9a28b3.js" defer></script><script src="/blog/_nuxt/22474fa.js" defer></script><script src="/blog/_nuxt/c1e6e7d.js" defer></script><script src="/blog/_nuxt/e7fe387.js" defer></script><script src="/blog/_nuxt/c57fec5.js" defer></script><script src="/blog/_nuxt/4f157bc.js" defer></script><script src="/blog/_nuxt/798d0e7.js" defer></script>
  </body>
</html>
