<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>TanxChen'blog</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"><meta data-n-head="ssr" name="keywords" content="ryanx chen blog"><meta data-n-head="ssr" data-hid="description" name="description" content="Tanx Chen's blog 编程&前端&记录总结个人成长"><base href="/blog/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script data-n-head="ssr" src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="preload" href="/blog/_nuxt/b9a28b3.js" as="script"><link rel="preload" href="/blog/_nuxt/c57fec5.js" as="script"><link rel="preload" href="/blog/_nuxt/4f157bc.js" as="script"><link rel="preload" href="/blog/_nuxt/798d0e7.js" as="script"><link rel="preload" href="/blog/_nuxt/6f52c49.js" as="script"><link rel="preload" href="/blog/_nuxt/c1e6e7d.js" as="script"><link rel="preload" href="/blog/_nuxt/e7fe387.js" as="script"><style data-vue-ssr-id="3a312388:0 f52d43e0:0 9b3ab808:0 fa7ff0ca:0 56b15182:0 f78f9946:0 01b54bb1:0 762dd866:0">a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,main,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}[hidden]{display:none}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:"";content:none}table{border-collapse:collapse;border-spacing:0}body,html{background-color:#fff;color:#000;letter-spacing:.5px;font-family:"Source Sans Pro",Arial,sans-serif;margin:0}a,a:focus,a:hover,a:visited{color:#000;text-decoration:none}a.link{color:#2196f3}.post{padding:25px 0 15px}.post .post-title{margin:0;color:#555;text-align:left;font:700 25px/1.1 ff-tisa-web-pro,Cambria,"Times New Roman",Georgia,Times,sans-serif}.post-title a{position:relative}.post-title a:hover:after{opacity:1;transform:scaleX(1)}.post-title a:after{position:absolute;bottom:-4px;left:0;right:0;height:3px;background:#000;content:"";opacity:0;transition:transform .1s ease-in;transform:scaleX(0)}.post .post-meta{padding:0;margin:15px 0 0;color:#6e7173;display:inline-block;text-indent:.15em}.post .post-meta:before{font-family:FontAwesome;content:"\f073";padding-right:.3em}.post .post-content{clear:left;font-size:16px;line-height:1.5;color:#444;padding-top:15px;text-align:justify;word-break:break-all}.readmore{padding:20px 0;text-align:right}.readmore a{font-size:14px;color:#444;padding:5px 10px;border:1px solid #ddd;border-radius:5px}.readmore a:hover{border:1px solid #999}.readmore a:after{font-family:FontAwesome;content:"\f101";padding-left:.3em}.blog-comments-wrap{padding-bottom:20px}.mdcontent h1,.mdcontent h2,.mdcontent h3,.mdcontent h4,.mdcontent h5,.mdcontent h6{font-weight:600;line-height:1.25;margin-bottom:16px;margin-top:24px}.mdcontent h1,.mdcontent h2{border-bottom:1px solid #eaecef;padding-bottom:.3em}.mdcontent h1{font-size:2em}.mdcontent h2{font-size:1.5em}.mdcontent code{background-color:#f6f8fa;padding:4px 6px;border-radius:4px}.mdcontent code a{background-color:rgba(27,31,35,.05)}.mdcontent p{margin:6px 0}.mdcontent blockquote{border-left:.25em solid #dfe2e5;color:#6a737d;padding:0 1em}.mdcontent li,.mdcontent ul{margin:initial;padding:initial}.mdcontent ul{padding-left:2em;margin-bottom:16px;margin-top:0}.mdcontent li{list-style:disc outside none;list-style:initial}.mdcontent img{max-width:100%}.mdcontent table{margin-bottom:16px;margin-top:0;border-collapse:collapse;border-spacing:0}.mdcontent table td,.mdcontent table th{border:1px solid #dfe2e5;padding:6px 13px;text-align:center}.mdcontent pre,.mdcontent pre[class*=language-]{border:1px solid #eaecef;background-color:#f6f8fa;padding:10px 20px;border-radius:4px;font-size:85%;line-height:1.45;overflow:auto;margin:10px 0}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#e91e63}.mdcontent pre code,.mdcontent pre[class*=language-] code{color:#525252}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#389d70}.token.punctuation{color:#2973b7}.token.boolean,.token.function,.token.number{color:#e96900}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#b3b3b3}.token.entity,.token.operator,.token.url{color:#cd6767}.token.tag{color:#3ca0e6}.token.attr-name,.token.deleted,.token.namespace{color:#fc9153}.token.punctuation{color:#666}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#3fb374}.token.property{color:#4a90e2}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.body-container{max-width:720px;min-width:320px;box-sizing:border-box;margin:0 auto;min-height:100vh;padding-bottom:60px}@media screen and (max-width:720px){.body-container{padding:0 20px 60px}}.title[data-v-4806b282]{color:#333}.bl-header{padding:20px 0 0;text-align:left;border-bottom:1px solid #ddd;position:relative;margin-bottom:25px}.site-name{margin-bottom:40px}.description{margin:.2em 0 0;color:#999}.nav-menu{margin:10px 0 -1px;padding:0;position:absolute;right:0;bottom:0}.nav-menu a{display:inline-block;padding:3px 20px;line-height:30px;color:#444;font-size:13px;border:1px solid transparent}.nav-menu a.nuxt-link-exact-active{border:1px solid;border-color:#ddd #ddd #fff}.bl-footer{border-top:1px solid #e5e5e5;max-width:720px;margin-left:auto;margin-right:auto;line-height:1.4;height:60px;box-sizing:border-box}.footer-wrap{display:flex;align-items:center;justify-content:center;height:100%;flex-flow:wrap}</style><link rel="preload" href="/blog/_nuxt/static/1636300541/article/5cdd790c9ae55c41e3feed97/state.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/article/5cdd790c9ae55c41e3feed97/payload.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><section class="container body-container" data-v-4806b282><div class="bl-header" data-v-4806b282><div class="site-name"><a href="/blog/" class="nuxt-link-active"><img src="/blog/_nuxt/img/logo_200_200.fc1fc4c.png" alt="logo" style="width:40px;height:40px;border-radius:5px"></a> <p class="description">Stay Hungry. Stay Foolish.</p></div> <div class="nav-menu"><a href="/blog/" class="current nuxt-link-active"><i class="fa fa-home"> 首页</i></a> <a href="/blog/about"><i class="fa fa-user"> 关于</i></a></div></div> <div class="post" data-v-4806b282><h1 class="post-title title" data-v-4806b282>
      vue源码阅读之初始化过程
    </h1> <div class="post-meta" data-v-4806b282>2019-05-16 22:51:56</div> <div class="article-mdcontent post-content mdcontent" data-v-4806b282><h3>import阶段</h3>
<p>从打包入口文件入手，<code>scripts/config.js</code>, ➡️ <code>resolve('web/entry-runtime.js')</code>
⤵️
入口文件 <code>src/platforms/entry-runtime.js</code>, <code>platforms</code> 文件夹是跟平台相关的代码
⤵️
<code>src/platforms/web/runtime/index.js</code>，<code>runtime/index.js</code> 里对该运行时代码做了特殊处理
⤵️
<code>src/code/index.js</code>,真正入口文件</p>
<pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'./instance/index'</span>
<span class="token comment">// ...</span>
<span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// ...ssr相关代码</span>
Vue<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'__VERSION__'</span>
<p><span class="token keyword">export</span> <span class="token keyword">default</span> Vue
</p></code></pre><p></p>
<p>⤵️
<code>src/core/instance/index.js</code></p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加 _init 函数</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要是添加了 $data,$props,$watch,$set,$delete 几个属性和方法</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要是添加了 $on,$off,$once,$emit 三个方法</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要添加了 _update, $forceUpdate, $destroy 三个方法</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 主要添加了 $nextTick 和 _render 两个方法以及一大堆renderHelpers</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<p><span class="token keyword">export</span> <span class="token keyword">default</span> Vue
</p></code></pre><p></p>
<p><code>instance/index.js</code> 作用是按功能模块往 <code>Vue</code> 原型和自身添加了许多属性和方法。
再回到 <code>initGlobalAPI(Vue)</code>.</p>
<pre class="language-js"><code><span class="token comment">// 一般使用的是实例里的方法</span>
Vue<span class="token punctuation">.</span>set <span class="token operator">=</span> <span class="token keyword">set</span>
Vue<span class="token punctuation">.</span>delete <span class="token operator">=</span> del
Vue<span class="token punctuation">.</span>nextTick <span class="token operator">=</span> nextTick
<p>Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">// 循环出来的结果其实是三个 <code>components</code>,<code>directives</code>, <code>filters</code></span>
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">‘s’</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></p>
<p><span class="token comment">// this is used to identify the “base” constructor to extend all plain-object</span>
<span class="token comment">// components with in Weex’s multi-instance scenarios.</span>
Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue</p>
<p><span class="token comment">// builtInComponents 仅为内置组件 KeepAlive</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span></p>
<p><span class="token function">initUse</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token comment">// 添加 Vue.use</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token comment">// 添加 Vue.mixin</span>
<span class="token function">initExtend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span> <span class="token comment">// 添加 Vue.extend</span>
<span class="token comment">// 添加 Vue.component, Vue.directive, Vue.filter 方法</span>
<span class="token function">initAssetRegisters</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
</p></code></pre><p></p>
<p><code>initGlobalAPI</code> 作用也是继续添加了一些全局方法。
现在 function Vue 大致就变成了如下样子：</p>
<pre class="language-js"><code><span class="token comment">//构造函数</span>
<span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<p><span class="token comment">//全局config对象，我们几乎不会用到</span>
Vue<span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token punctuation">{</span>
keyCodes<span class="token punctuation">,</span>
_lifecycleHooks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">‘beforeCreate’</span><span class="token punctuation">,</span> <span class="token string">‘created’</span><span class="token punctuation">,</span> <span class="token operator">…</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></p>
<p><span class="token comment">// 默认的options配置，我们每个组件都会继承这个配置。</span>
Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
beforeCreate<span class="token punctuation">,</span> <span class="token comment">// 比如 vue-router 就会注册这个回调，因此会每一个组件继承</span>
components<span class="token punctuation">,</span> <span class="token comment">// 前面提到了，默认组件有三个 <code>KeepAlive</code>,<code>transition</code>, <code>transitionGroup</code>，这里注册的组件就是全局组件，因为任何一个组件中不用声明就能用了。所以全局组件的原理就是这么简单</span>
directives<span class="token punctuation">,</span> <span class="token comment">// 默认只有 <code>v-show</code> 和 <code>v-model</code></span>
filters
<span class="token punctuation">}</span></p>
<p><span class="token comment">//一些全局方法</span>
Vue<span class="token punctuation">.</span>use <span class="token comment">// 注册插件</span>
Vue<span class="token punctuation">.</span>component <span class="token comment">// 注册组件</span>
Vue<span class="token punctuation">.</span>directive <span class="token comment">// 注册指令</span>
Vue<span class="token punctuation">.</span>nextTick <span class="token comment">//下一个tick执行函数</span>
Vue<span class="token punctuation">.</span>set<span class="token operator">/</span><span class="token keyword">delete</span> <span class="token comment">// 数据的修改操作</span>
Vue<span class="token punctuation">.</span>mixin <span class="token comment">// 混入mixin用的</span></p>
<p><span class="token comment">//Vue.prototype 上有几种不同作用的方法</span></p>
<p><span class="token comment">//由initMixin 添加的 <code>_init</code> 方法，是Vue实例初始化的入口方法，会调用其他的功能初始话函数</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_init</p>
<p><span class="token comment">// 由 initState 添加的三个用来进行数据操作的方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$data
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$props
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$watch
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$set
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token keyword">delete</span></p>
<p><span class="token comment">// 由initEvents添加的事件方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$on
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$off
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$one
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$emit</p>
<p><span class="token comment">// 由 lifecycle添加的生命周期相关的方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_update
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$forceUpdate
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$destroy</p>
<p><span class="token comment">//在 platform 中添加的生命周期方法</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount</p>
<p><span class="token comment">// 由renderMixin添加的<code>$nextTick</code> 和 <code>_render</code> 以及一堆renderHelper</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$nextTick
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_render
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_b
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>_e
<span class="token comment">//…</span>
</p></code></pre><p></p>
<h3>实例化阶段[new Vue({…})]</h3>
<p>代码在 <code>src/core/instance/init.js</code> 里。
主要功能代码：</p>
<ul>
<li>生成自增的唯一ID标识 <code>vm._uid = uid++</code></li>
<li>合并 <code>vm.constructor</code> 和传入的 <code>options</code>，生成 <code>vm.$options</code>
<ul>
<li>这一步使得可以在子组件能够使用全局的 directives、filters 等方法</li>
</ul>
</li>
<li>挂载自身 <code>vm._self = vm</code></li>
<li>初始化生命周期、事件、渲染等相关钩子工作
<ul>
<li>initLifecycle(vm)
<ul>
<li>定位第一个非抽象父级，并添加到 $children 里，<code>parent.$children.push(vm)</code></li>
<li>添加很多变量，主要为 $parent、$children，$refs 也在这里定义了，其他 <code>_</code>开头的变量均为生命周期不同阶段状态的 flag
<ul>
<li>vm.$parent = parent</li>
<li>vm.$root = parent ? parent.$root : vm</li>
<li>vm.$children = []</li>
<li>vm.$refs = {}</li>
<li>vm._watcher = null</li>
<li>vm._inactive = null</li>
<li>vm._directInactive = false</li>
<li>vm._isMounted = false</li>
<li>vm._isDestroyed = false</li>
<li>vm._isBeingDestroyed = false</li>
</ul>
</li>
</ul>
</li>
<li>initEvents(vm)
<ul>
<li>
<blockquote>
<p><strong>注册的是父组件事件</strong></p>
</blockquote>
</li>
</ul>
</li>
<li>initRender(vm)
<ul>
<li>做 render 的准备工作，并未开始 render，如创建 vm._vnode，vm.$createElement，$attrs 和 $listeners</li>
</ul>
</li>
<li>callHook(vm, ‘beforeCreate’)
<ul>
<li>调用 <code>beforeCreate</code> 生命周期钩子</li>
<li>
<blockquote>
<p>callHook 里定义了：<code>if (vm._hasHookEvent) {vm.$emit('hook:' + hook)}</code>，所以有个小技巧实现在在父组件通过 <code>hook</code> 钩子，监听子组件生命周期方法:</p>
</blockquote>
</li>
<li>
<pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Chind-Component</span> <span class="token attr-name"><span class="token namespace">@hook:</span>updated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>doSomething<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span> 
</code></pre>
</li>
</ul>
</li>
<li>initInjections(vm) // resolve injections before data/props</li>
<li>initState(vm)
<ul>
<li><code>data</code>, <code>props</code>, <code>computed</code> 等都是在这里初始化的，常见的面试考点比如<code>Vue是如何实现数据响应化的</code> 答案就在这个函数中寻找</li>
</ul>
</li>
<li>initProvide(vm) // resolve provide after data/props</li>
<li>callHook(vm, ‘created’)
<ul>
<li>调用 <code>created</code> 生命周期钩子</li>
</ul>
</li>
</ul>
</li>
<li>存在 el ,则调用 <code>$mount</code>，<code>vm.$mount(vm.$options.el)</code>
<ul>
<li>当然，el 也可以不写，而是在实例化的时候直接调用： <code>new Vue({...}).$mount('#app')</code></li>
</ul>
</li>
</ul>
</div> <div id="article-gitalk-container" class="blog-comments-wrap" data-v-4806b282></div></div></section> <footer class="bl-footer" style="position:relative;margin-top:-60px"><div class="footer-wrap"><div style="text-align:center">
      2018-present © by <a href="#" target="_blank">TanxChen</a> All Rights Reserved. <a href="http://www.miitbeian.gov.cn" target="_blank">浙ICP备18014267号-1</a></div></div></footer></div></div></div><script defer src="/blog/_nuxt/static/1636300541/article/5cdd790c9ae55c41e3feed97/state.js"></script><script src="/blog/_nuxt/b9a28b3.js" defer></script><script src="/blog/_nuxt/6f52c49.js" defer></script><script src="/blog/_nuxt/c1e6e7d.js" defer></script><script src="/blog/_nuxt/e7fe387.js" defer></script><script src="/blog/_nuxt/c57fec5.js" defer></script><script src="/blog/_nuxt/4f157bc.js" defer></script><script src="/blog/_nuxt/798d0e7.js" defer></script>
  </body>
</html>
