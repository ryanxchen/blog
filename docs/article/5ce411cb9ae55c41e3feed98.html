<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>TanxChen'blog</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"><meta data-n-head="ssr" name="keywords" content="ryanx chen blog"><meta data-n-head="ssr" data-hid="description" name="description" content="Tanx Chen's blog 编程&前端&记录总结个人成长"><base href="/blog/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script data-n-head="ssr" src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="preload" href="/blog/_nuxt/b9a28b3.js" as="script"><link rel="preload" href="/blog/_nuxt/c57fec5.js" as="script"><link rel="preload" href="/blog/_nuxt/4f157bc.js" as="script"><link rel="preload" href="/blog/_nuxt/798d0e7.js" as="script"><link rel="preload" href="/blog/_nuxt/6f52c49.js" as="script"><link rel="preload" href="/blog/_nuxt/c1e6e7d.js" as="script"><link rel="preload" href="/blog/_nuxt/e7fe387.js" as="script"><style data-vue-ssr-id="3a312388:0 f52d43e0:0 9b3ab808:0 fa7ff0ca:0 56b15182:0 f78f9946:0 01b54bb1:0 762dd866:0">a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,main,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}[hidden]{display:none}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:"";content:none}table{border-collapse:collapse;border-spacing:0}body,html{background-color:#fff;color:#000;letter-spacing:.5px;font-family:"Source Sans Pro",Arial,sans-serif;margin:0}a,a:focus,a:hover,a:visited{color:#000;text-decoration:none}a.link{color:#2196f3}.post{padding:25px 0 15px}.post .post-title{margin:0;color:#555;text-align:left;font:700 25px/1.1 ff-tisa-web-pro,Cambria,"Times New Roman",Georgia,Times,sans-serif}.post-title a{position:relative}.post-title a:hover:after{opacity:1;transform:scaleX(1)}.post-title a:after{position:absolute;bottom:-4px;left:0;right:0;height:3px;background:#000;content:"";opacity:0;transition:transform .1s ease-in;transform:scaleX(0)}.post .post-meta{padding:0;margin:15px 0 0;color:#6e7173;display:inline-block;text-indent:.15em}.post .post-meta:before{font-family:FontAwesome;content:"\f073";padding-right:.3em}.post .post-content{clear:left;font-size:16px;line-height:1.5;color:#444;padding-top:15px;text-align:justify;word-break:break-all}.readmore{padding:20px 0;text-align:right}.readmore a{font-size:14px;color:#444;padding:5px 10px;border:1px solid #ddd;border-radius:5px}.readmore a:hover{border:1px solid #999}.readmore a:after{font-family:FontAwesome;content:"\f101";padding-left:.3em}.blog-comments-wrap{padding-bottom:20px}.mdcontent h1,.mdcontent h2,.mdcontent h3,.mdcontent h4,.mdcontent h5,.mdcontent h6{font-weight:600;line-height:1.25;margin-bottom:16px;margin-top:24px}.mdcontent h1,.mdcontent h2{border-bottom:1px solid #eaecef;padding-bottom:.3em}.mdcontent h1{font-size:2em}.mdcontent h2{font-size:1.5em}.mdcontent code{background-color:#f6f8fa;padding:4px 6px;border-radius:4px}.mdcontent code a{background-color:rgba(27,31,35,.05)}.mdcontent p{margin:6px 0}.mdcontent blockquote{border-left:.25em solid #dfe2e5;color:#6a737d;padding:0 1em}.mdcontent li,.mdcontent ul{margin:initial;padding:initial}.mdcontent ul{padding-left:2em;margin-bottom:16px;margin-top:0}.mdcontent li{list-style:disc outside none;list-style:initial}.mdcontent img{max-width:100%}.mdcontent table{margin-bottom:16px;margin-top:0;border-collapse:collapse;border-spacing:0}.mdcontent table td,.mdcontent table th{border:1px solid #dfe2e5;padding:6px 13px;text-align:center}.mdcontent pre,.mdcontent pre[class*=language-]{border:1px solid #eaecef;background-color:#f6f8fa;padding:10px 20px;border-radius:4px;font-size:85%;line-height:1.45;overflow:auto;margin:10px 0}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#e91e63}.mdcontent pre code,.mdcontent pre[class*=language-] code{color:#525252}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#389d70}.token.punctuation{color:#2973b7}.token.boolean,.token.function,.token.number{color:#e96900}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#b3b3b3}.token.entity,.token.operator,.token.url{color:#cd6767}.token.tag{color:#3ca0e6}.token.attr-name,.token.deleted,.token.namespace{color:#fc9153}.token.punctuation{color:#666}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#3fb374}.token.property{color:#4a90e2}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.body-container{max-width:720px;min-width:320px;box-sizing:border-box;margin:0 auto;min-height:100vh;padding-bottom:60px}@media screen and (max-width:720px){.body-container{padding:0 20px 60px}}.title[data-v-4806b282]{color:#333}.bl-header{padding:20px 0 0;text-align:left;border-bottom:1px solid #ddd;position:relative;margin-bottom:25px}.site-name{margin-bottom:40px}.description{margin:.2em 0 0;color:#999}.nav-menu{margin:10px 0 -1px;padding:0;position:absolute;right:0;bottom:0}.nav-menu a{display:inline-block;padding:3px 20px;line-height:30px;color:#444;font-size:13px;border:1px solid transparent}.nav-menu a.nuxt-link-exact-active{border:1px solid;border-color:#ddd #ddd #fff}.bl-footer{border-top:1px solid #e5e5e5;max-width:720px;margin-left:auto;margin-right:auto;line-height:1.4;height:60px;box-sizing:border-box}.footer-wrap{display:flex;align-items:center;justify-content:center;height:100%;flex-flow:wrap}</style><link rel="preload" href="/blog/_nuxt/static/1636300541/article/5ce411cb9ae55c41e3feed98/state.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/article/5ce411cb9ae55c41e3feed98/payload.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><section class="container body-container" data-v-4806b282><div class="bl-header" data-v-4806b282><div class="site-name"><a href="/blog/" class="nuxt-link-active"><img src="/blog/_nuxt/img/logo_200_200.fc1fc4c.png" alt="logo" style="width:40px;height:40px;border-radius:5px"></a> <p class="description">Stay Hungry. Stay Foolish.</p></div> <div class="nav-menu"><a href="/blog/" class="current nuxt-link-active"><i class="fa fa-home"> 首页</i></a> <a href="/blog/about"><i class="fa fa-user"> 关于</i></a></div></div> <div class="post" data-v-4806b282><h1 class="post-title title" data-v-4806b282>
      vue源码阅读之响应式原理
    </h1> <div class="post-meta" data-v-4806b282>2019-05-21 22:57:15</div> <div class="article-mdcontent post-content mdcontent" data-v-4806b282><p>Vue 中对数据的响应式，即对 <code>props</code>、<code>data</code>、<code>computed</code> 的变化进行响应式更改。</p>
<p>其入口是在 <code>src/core/instance/init.js</code> 里的 <code>initState(vm)</code> 里进行实现的。</p>
<p><code>initState(vm)</code> 里 初始化了 <code>props</code>, <code>methods</code>, <code>data</code>, <code>computed</code>, <code>watch</code>。</p>
<h3>initData</h3>
<p>从 <code>initData</code> 入手来看下：</p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initData</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data
  <span class="token comment">// 将_data作为中间变量，后续 proxy 里会用到</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token comment">// getData 做了错误处理，并控制了 Dep.target，使得避免在获取 data 初始值的过程中意外地把依赖记录下来。</span>
    <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 省略相关 warn 代码...</span>
  <span class="token comment">// 进行 data proxy methods 重复 key 的检验并抛出 warn msg</span>
  <span class="token comment">// proxy data on instance</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">// 省略相关关于重复 key 检测 warn 代码</span>
    <span class="token comment">// 对 _data 对象上的每个 key 进行 getter setter 设置</span>
    <span class="token comment">// 使得访问 this.xxx 代理到 this._data.xxx</span>
    <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// observe data</span>
  <span class="token comment">/**
   * 响应式核心方法
   * 即 new Observer(value)
   * 具体看 new Observer(value) 逻辑
   * */</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>initData</code> 里首先将原始 data 复制了份 _data，然后遍历了每个 key，
通过 <code>proxy</code> 方法对 _data 里的 key 进行了 getter setter 设置。</p>
<p>使得访问 this.xxx 代理到 this._data.xxx。</p>
<p>接下来执行 <code>observe(data, true /* asRootData */)</code>。</p>
<p>该方法结果是 <code>return new Observer(value)</code>，返回了一个 <code>Observer</code> 实例。</p>
<h3>Observer</h3>
<p>来看下 <code>Observer</code> 类的定义，这也是响应式实现的主要地方。</p>
<details>
  <summary>class Observer 源码</summary>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> any<span class="token punctuation">;</span>
  dep<span class="token operator">:</span> Dep<span class="token punctuation">;</span>
  vmCount<span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">// number of vms that has this object as root $data</span>
<p><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
<span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 添加 <strong>ob</strong> 属性，值为自身，即 this.data.<strong>ob</strong> = this</span>
<span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">‘<strong>ob</strong>’</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 对数组原生方法进行了劫持，使得push 等能监控到，来触发响应式，但无法监控到 通过下标更改的情况</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 对数组进行遍历执行 observe</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment">// 会进入 walk 方法</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></p>
<p><span class="token comment">/**</span></p>
<ul>
<li>Walk through each property and convert them into</li>
<li>getter/setters. This method should only be called when</li>
<li>value type is Object.
*/
<span class="token function">walk</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 通过 defineReactive 方法，设置 getter setter, 真正的响应代码</span>
<span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></li>
</ul>
<p><span class="token comment">/**</span></p>
<ul>
<li>Observe a list of Array items.
*/
<span class="token function">observeArray</span> <span class="token punctuation">(</span><span class="token parameter">items<span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">></span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</li></ul></code></pre>

</details>
<p><code>Observer</code> 在 new 的时候，主要逻辑会先执行 <code>this.dep = new Dep()</code> 来创建依赖实例，然后处理数组/对象的情况。</p>
<p>这中间还对里面的每个元素进行了深度遍历，使得每个元素均是响应式的。</p>
<p>再主要来看 <code>this.walk(value)</code> 方法，该方法通过 <code>defineReactive</code> 方法，设置 getter setter，这是真正的响应代码。</p>
<details>
  <summary>defineReactive 源码</summary>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span>
  <span class="token parameter">obj<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  key<span class="token operator">:</span> string<span class="token punctuation">,</span>
  val<span class="token operator">:</span> any<span class="token punctuation">,</span>
  customSetter<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
  shallow<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 缓存依赖</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<p><span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&&</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span>
<span class="token punctuation">}</span></p>
<p><span class="token comment">// cater for pre-defined getter/setters</span>
<span class="token comment">// 这里代码类比 computed 里属性定义的 getter setter 那样</span>
<span class="token comment">// 定义了，就用定义的 getter setter 方法</span>
<span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&&</span> property<span class="token punctuation">.</span>get
<span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&&</span> property<span class="token punctuation">.</span>set
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&&</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token comment">// childObserve 对象，对 child 进行监听</span>
<span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&&</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token comment">// 这步主要收集依赖，并返回值</span>
<span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 兼容使用定义的 getter 情况</span>
<span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
<span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> value
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 这步触发依赖并设置值</span>
<span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
<span class="token comment">/* eslint-disable no-self-compare <em>/</em></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&&</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span class="token comment">/ eslint-enable no-self-compare */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">‘production’</span> <span class="token operator">&&</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// #7981: for accessor properties without setter</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&&</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token keyword">return</span>
<span class="token comment">// 自己定义了 setter 就调用自己的 setter, 没有就直接赋值</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
val <span class="token operator">=</span> newVal
<span class="token punctuation">}</span>
<span class="token comment">// newVal 是个 object，则继续递归执行监听 observe</span>
childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&&</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
<span class="token comment">// 触发更新</span>
dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
</details>
<p><code>defineReactive</code> 代码可以简化如下：</p>
<pre class="language-js"><code><span class="token function">_defineReactive</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token comment">// 自己定义了 setter 就调用自己的 setter, 没有就直接赋值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> newVal
      <span class="token punctuation">}</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在 <code>defineReactive</code> 函数内，通过闭包实例化了 <code>Dep</code> 这个订阅者。</p>
<h3>Dep</h3>
<details>
  <summary>class Dep 源码</summary>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> target<span class="token operator">:</span> <span class="token operator">?</span>Watcher<span class="token punctuation">;</span>
  id<span class="token operator">:</span> number<span class="token punctuation">;</span>
  subs<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Watcher<span class="token operator">></span><span class="token punctuation">;</span>
<p><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></p>
<p><span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter">sub<span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
<span class="token punctuation">}</span></p>
<p><span class="token function">removeSub</span> <span class="token punctuation">(</span><span class="token parameter">sub<span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>
<span class="token punctuation">}</span></p>
<p><span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// Dep.target 即 watcher：watcher.addDep(dep)</span>
Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></p>
<p><span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// stabilize the subscriber list first</span>
<span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">‘production’</span> <span class="token operator">&&</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// subs aren’t sorted in scheduler if not running async</span>
<span class="token comment">// we need to sort them now to make sure they fire in correct</span>
<span class="token comment">// order</span>
subs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></p>
<p><span class="token comment">// the current target watcher being evaluated.</span>
<span class="token comment">// this is globally unique because there could be only one</span>
<span class="token comment">// watcher being evaluated at any time.</span>
<span class="token comment">// 保存当前全局唯一存在的 watcher</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></p>
<p><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span> <span class="token punctuation">(</span><span class="token parameter">_target<span class="token operator">:</span> <span class="token operator">?</span>Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> _target
<span class="token punctuation">}</span></p>
<p><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popTarget</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
</details>
<p><code>Dep</code> 这里可以简化为：</p>
<pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<p>Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
</p></code></pre><p></p>
<p><code>Dep</code> 这个依赖订阅者，有自己的 <code>subs</code> 用来缓存 <code>Dep.target</code>，<code>Dep.target</code> 其实是一个 watcher 实例，这里先不管 watcher。
回到 <code>defineReactive</code>，在 get 里将 watcher 实例添加到订阅者 Dep 里，
在 set 时遍历缓存在 dep.subs 数组里的 watcher 实例，执行 <code>watcher.update()</code> 方法，来触发更新。</p>
<h3>Watcher</h3>
<p>来看下 class Watcher</p>
<details>
  <summary>class Watcher 源码</summary>
<pre class="language-js"><code>  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    vm<span class="token operator">:</span> Component<span class="token punctuation">;</span> <span class="token comment">// 实例自身</span>
    expression<span class="token operator">:</span> string<span class="token punctuation">;</span>
    cb<span class="token operator">:</span> Function<span class="token punctuation">;</span>
    id<span class="token operator">:</span> number<span class="token punctuation">;</span>
    deep<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    user<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    lazy<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    sync<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    dirty<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    active<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    deps<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>
    newDeps<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Dep<span class="token operator">></span><span class="token punctuation">;</span>
    depIds<span class="token operator">:</span> SimpleSet<span class="token punctuation">;</span> <span class="token comment">// ES6 set 类型</span>
    newDepIds<span class="token operator">:</span> SimpleSet<span class="token punctuation">;</span> <span class="token comment">// ES6 set 类型</span>
    before<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">;</span>
    getter<span class="token operator">:</span> Function<span class="token punctuation">;</span>
    value<span class="token operator">:</span> any<span class="token punctuation">;</span>
<pre><code>&lt;span class="token function">constructor&lt;/span> &lt;span class="token punctuation">(&lt;/span>
  vm&lt;span class="token operator">:&lt;/span> Component&lt;span class="token punctuation">,&lt;/span>
  expOrFn&lt;span class="token operator">:&lt;/span> string &lt;span class="token operator">|&lt;/span> Function&lt;span class="token punctuation">,&lt;/span> &lt;span class="token comment">// 表达式本身 [ getter | noop ]&lt;/span>
  cb&lt;span class="token operator">:&lt;/span> Function&lt;span class="token punctuation">,&lt;/span> &lt;span class="token comment">// [ noop ]&lt;/span>
  options&lt;span class="token operator">?&lt;/span>&lt;span class="token operator">:&lt;/span> &lt;span class="token operator">?&lt;/span>Object&lt;span class="token punctuation">,&lt;/span> &lt;span class="token comment">// { lazy: true } // 如果设置为 true 则在第一次 get 的时候才计算值，初始化的时候并不计算。init 时为 true&lt;/span>
  isRenderWatcher&lt;span class="token operator">?&lt;/span>&lt;span class="token operator">:&lt;/span> boolean
&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>vm &lt;span class="token operator">=&lt;/span> vm
  &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>isRenderWatcher&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    vm&lt;span class="token punctuation">.&lt;/span>_watcher &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
  vm&lt;span class="token punctuation">.&lt;/span>_watchers&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">push&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token comment">// options&lt;/span>
  &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>options&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deep &lt;span class="token operator">=&lt;/span> &lt;span class="token operator">!&lt;/span>&lt;span class="token operator">!&lt;/span>options&lt;span class="token punctuation">.&lt;/span>deep
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>user &lt;span class="token operator">=&lt;/span> &lt;span class="token operator">!&lt;/span>&lt;span class="token operator">!&lt;/span>options&lt;span class="token punctuation">.&lt;/span>user
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>lazy &lt;span class="token operator">=&lt;/span> &lt;span class="token operator">!&lt;/span>&lt;span class="token operator">!&lt;/span>options&lt;span class="token punctuation">.&lt;/span>lazy
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>sync &lt;span class="token operator">=&lt;/span> &lt;span class="token operator">!&lt;/span>&lt;span class="token operator">!&lt;/span>options&lt;span class="token punctuation">.&lt;/span>sync
    &lt;span class="token comment">/*
    before作用是定义 beforeUpdate 钩子：
    「
      before () {
          if (vm._isMounted) {
            callHook(vm, 'beforeUpdate')
          }
        }
      」
    */&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>before &lt;span class="token operator">=&lt;/span> options&lt;span class="token punctuation">.&lt;/span>before
  &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">else&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deep &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>user &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>lazy &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>sync &lt;span class="token operator">=&lt;/span> &lt;span class="token boolean">false&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>cb &lt;span class="token operator">=&lt;/span> cb
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>id &lt;span class="token operator">=&lt;/span> &lt;span class="token operator">++&lt;/span>uid &lt;span class="token comment">// uid for batching&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>active &lt;span class="token operator">=&lt;/span> &lt;span class="token boolean">true&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>dirty &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>lazy &lt;span class="token comment">// for lazy watchers&lt;/span>
  &lt;span class="token comment">// 两个数组，&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps &lt;span class="token operator">=&lt;/span> &lt;span class="token punctuation">[&lt;/span>&lt;span class="token punctuation">]&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDeps &lt;span class="token operator">=&lt;/span> &lt;span class="token punctuation">[&lt;/span>&lt;span class="token punctuation">]&lt;/span>
  &lt;span class="token comment">// 两个id 为 set 实例,在 add 时候，防止重复添加相同 id&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>depIds &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">new&lt;/span> &lt;span class="token class-name">Set&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDepIds &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">new&lt;/span> &lt;span class="token class-name">Set&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>expression &lt;span class="token operator">=&lt;/span> process&lt;span class="token punctuation">.&lt;/span>env&lt;span class="token punctuation">.&lt;/span>&lt;span class="token constant">NODE_ENV&lt;/span> &lt;span class="token operator">!==&lt;/span> &lt;span class="token string">'production'&lt;/span>
    &lt;span class="token operator">?&lt;/span> expOrFn&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">toString&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token operator">:&lt;/span> &lt;span class="token string">''&lt;/span>
  &lt;span class="token comment">// parse expression for getter&lt;/span>
  &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">typeof&lt;/span> expOrFn &lt;span class="token operator">===&lt;/span> &lt;span class="token string">'function'&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>getter &lt;span class="token operator">=&lt;/span> expOrFn
  &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">else&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>getter &lt;span class="token operator">=&lt;/span> &lt;span class="token function">parsePath&lt;/span>&lt;span class="token punctuation">(&lt;/span>expOrFn&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token operator">!&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>getter&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>getter &lt;span class="token operator">=&lt;/span> noop
      process&lt;span class="token punctuation">.&lt;/span>env&lt;span class="token punctuation">.&lt;/span>&lt;span class="token constant">NODE_ENV&lt;/span> &lt;span class="token operator">!==&lt;/span> &lt;span class="token string">'production'&lt;/span> &lt;span class="token operator">&ampamp;&ampamp;&lt;/span> &lt;span class="token function">warn&lt;/span>&lt;span class="token punctuation">(&lt;/span>
        &lt;span class="token template-string">&lt;span class="token template-punctuation string">`&lt;/span>&lt;span class="token string">Failed watching path: "&lt;/span>&lt;span class="token interpolation">&lt;span class="token interpolation-punctuation punctuation">${&lt;/span>expOrFn&lt;span class="token interpolation-punctuation punctuation">}&lt;/span>&lt;/span>&lt;span class="token string">" &lt;/span>&lt;span class="token template-punctuation string">`&lt;/span>&lt;/span> &lt;span class="token operator">+&lt;/span>
        &lt;span class="token string">'Watcher only accepts simple dot-delimited paths. '&lt;/span> &lt;span class="token operator">+&lt;/span>
        &lt;span class="token string">'For full control, use a function instead.'&lt;/span>&lt;span class="token punctuation">,&lt;/span>
        vm
      &lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>value &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>lazy
    &lt;span class="token operator">?&lt;/span> &lt;span class="token keyword">undefined&lt;/span>
    &lt;span class="token operator">:&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">get&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Evaluate the getter, and re-collect dependencies.
 */&lt;/span>
&lt;span class="token comment">// 执行 getter, 并重新收集依赖关系&lt;/span>
&lt;span class="token function">get&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token comment">/* pushTarget 代码：
  「
      Dep.target = null
      const targetStack = []

      export function pushTarget (_target: ?Watcher) {
        if (Dep.target) targetStack.push(Dep.target)
        Dep.target = _target
      }

      export function popTarget () {
        Dep.target = targetStack.pop()
      }
    」
  */&lt;/span>
  &lt;span class="token comment">// 这行代码作用：在进行 get 取值时，使得 Dep.target 为 watcher 实例自身&lt;/span>
  &lt;span class="token function">pushTarget&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token keyword">let&lt;/span> value
  &lt;span class="token keyword">const&lt;/span> vm &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>vm
  &lt;span class="token keyword">try&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    value &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">getter&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">call&lt;/span>&lt;span class="token punctuation">(&lt;/span>vm&lt;span class="token punctuation">,&lt;/span> vm&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">catch&lt;/span> &lt;span class="token punctuation">(&lt;/span>e&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>user&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      &lt;span class="token function">handleError&lt;/span>&lt;span class="token punctuation">(&lt;/span>e&lt;span class="token punctuation">,&lt;/span> vm&lt;span class="token punctuation">,&lt;/span> &lt;span class="token template-string">&lt;span class="token template-punctuation string">`&lt;/span>&lt;span class="token string">getter for watcher "&lt;/span>&lt;span class="token interpolation">&lt;span class="token interpolation-punctuation punctuation">${&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>expression&lt;span class="token interpolation-punctuation punctuation">}&lt;/span>&lt;/span>&lt;span class="token string">"&lt;/span>&lt;span class="token template-punctuation string">`&lt;/span>&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">else&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      &lt;span class="token keyword">throw&lt;/span> e
    &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">finally&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token comment">// "touch" every property so they are all tracked as&lt;/span>
    &lt;span class="token comment">// dependencies for deep watching&lt;/span>
    &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deep&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      &lt;span class="token function">traverse&lt;/span>&lt;span class="token punctuation">(&lt;/span>value&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token punctuation">}&lt;/span>
    &lt;span class="token function">popTarget&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">cleanupDeps&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token keyword">return&lt;/span> value
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Add a dependency to this directive.
 */&lt;/span>
&lt;span class="token function">addDep&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token parameter">dep&lt;span class="token operator">:&lt;/span> Dep&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token keyword">const&lt;/span> id &lt;span class="token operator">=&lt;/span> dep&lt;span class="token punctuation">.&lt;/span>id
  &lt;span class="token comment">// if (!this.newDepIds.has(id)) 判断，为了防止如 computed 里&lt;/span>
  &lt;span class="token comment">// `return this.a + this.a` 这种相同值的计算情况&lt;/span>
  &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token operator">!&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDepIds&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">has&lt;/span>&lt;span class="token punctuation">(&lt;/span>id&lt;span class="token punctuation">)&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDepIds&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">add&lt;/span>&lt;span class="token punctuation">(&lt;/span>id&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDeps&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">push&lt;/span>&lt;span class="token punctuation">(&lt;/span>dep&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token operator">!&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>depIds&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">has&lt;/span>&lt;span class="token punctuation">(&lt;/span>id&lt;span class="token punctuation">)&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      dep&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">addSub&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Clean up for dependency collection.
 */&lt;/span>
&lt;span class="token function">cleanupDeps&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token keyword">let&lt;/span> i &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps&lt;span class="token punctuation">.&lt;/span>length
  &lt;span class="token keyword">while&lt;/span> &lt;span class="token punctuation">(&lt;/span>i&lt;span class="token operator">--&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">const&lt;/span> dep &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps&lt;span class="token punctuation">[&lt;/span>i&lt;span class="token punctuation">]&lt;/span>
    &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token operator">!&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDepIds&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">has&lt;/span>&lt;span class="token punctuation">(&lt;/span>dep&lt;span class="token punctuation">.&lt;/span>id&lt;span class="token punctuation">)&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      dep&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">removeSub&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token keyword">let&lt;/span> tmp &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>depIds
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>depIds &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDepIds
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDepIds &lt;span class="token operator">=&lt;/span> tmp
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDepIds&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">clear&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  tmp &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDeps
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDeps &lt;span class="token operator">=&lt;/span> tmp
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>newDeps&lt;span class="token punctuation">.&lt;/span>length &lt;span class="token operator">=&lt;/span> &lt;span class="token number">0&lt;/span>
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Subscriber interface.
 * Will be called when a dependency changes.
 */&lt;/span>
&lt;span class="token function">update&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token comment">/* istanbul ignore else */&lt;/span>
  &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>lazy&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>dirty &lt;span class="token operator">=&lt;/span> &lt;span class="token boolean">true&lt;/span>
  &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">else&lt;/span> &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>sync&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">run&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">else&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token function">queueWatcher&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Scheduler job interface.
 * Will be called by the scheduler.
 */&lt;/span>
&lt;span class="token function">run&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>active&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">const&lt;/span> value &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">get&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>
      value &lt;span class="token operator">!==&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>value &lt;span class="token operator">||&lt;/span>
      &lt;span class="token comment">// Deep watchers and watchers on Object/Arrays should fire even&lt;/span>
      &lt;span class="token comment">// when the value is the same, because the value may&lt;/span>
      &lt;span class="token comment">// have mutated.&lt;/span>
      &lt;span class="token function">isObject&lt;/span>&lt;span class="token punctuation">(&lt;/span>value&lt;span class="token punctuation">)&lt;/span> &lt;span class="token operator">||&lt;/span>
      &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deep
    &lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      &lt;span class="token comment">// set new value&lt;/span>
      &lt;span class="token keyword">const&lt;/span> oldValue &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>value
      &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>value &lt;span class="token operator">=&lt;/span> value
      &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>user&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
        &lt;span class="token keyword">try&lt;/span> &lt;span class="token punctuation">{&lt;/span>
          &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">cb&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">call&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>vm&lt;span class="token punctuation">,&lt;/span> value&lt;span class="token punctuation">,&lt;/span> oldValue&lt;span class="token punctuation">)&lt;/span>
        &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">catch&lt;/span> &lt;span class="token punctuation">(&lt;/span>e&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
          &lt;span class="token function">handleError&lt;/span>&lt;span class="token punctuation">(&lt;/span>e&lt;span class="token punctuation">,&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>vm&lt;span class="token punctuation">,&lt;/span> &lt;span class="token template-string">&lt;span class="token template-punctuation string">`&lt;/span>&lt;span class="token string">callback for watcher "&lt;/span>&lt;span class="token interpolation">&lt;span class="token interpolation-punctuation punctuation">${&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>expression&lt;span class="token interpolation-punctuation punctuation">}&lt;/span>&lt;/span>&lt;span class="token string">"&lt;/span>&lt;span class="token template-punctuation string">`&lt;/span>&lt;/span>&lt;span class="token punctuation">)&lt;/span>
        &lt;span class="token punctuation">}&lt;/span>
      &lt;span class="token punctuation">}&lt;/span> &lt;span class="token keyword">else&lt;/span> &lt;span class="token punctuation">{&lt;/span>
        &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">cb&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">call&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>vm&lt;span class="token punctuation">,&lt;/span> value&lt;span class="token punctuation">,&lt;/span> oldValue&lt;span class="token punctuation">)&lt;/span>
      &lt;span class="token punctuation">}&lt;/span>
    &lt;span class="token punctuation">}&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Evaluate the value of the watcher.
 * This only gets called for lazy watchers.
 */&lt;/span>
&lt;span class="token function">evaluate&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>value &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">get&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>dirty &lt;span class="token operator">=&lt;/span> &lt;span class="token boolean">false&lt;/span>
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Depend on all deps collected by this watcher.
 */&lt;/span>
&lt;span class="token function">depend&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token keyword">let&lt;/span> i &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps&lt;span class="token punctuation">.&lt;/span>length
  &lt;span class="token keyword">while&lt;/span> &lt;span class="token punctuation">(&lt;/span>i&lt;span class="token operator">--&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps&lt;span class="token punctuation">[&lt;/span>i&lt;span class="token punctuation">]&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">depend&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
&lt;span class="token punctuation">}&lt;/span>

&lt;span class="token comment">/**
 * Remove self from all dependencies' subscriber list.
 */&lt;/span>
&lt;span class="token function">teardown&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
  &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>active&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
    &lt;span class="token comment">// remove self from vm's watcher list&lt;/span>
    &lt;span class="token comment">// this is a somewhat expensive operation so we skip it&lt;/span>
    &lt;span class="token comment">// if the vm is being destroyed.&lt;/span>
    &lt;span class="token keyword">if&lt;/span> &lt;span class="token punctuation">(&lt;/span>&lt;span class="token operator">!&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>vm&lt;span class="token punctuation">.&lt;/span>_isBeingDestroyed&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      &lt;span class="token function">remove&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>vm&lt;span class="token punctuation">.&lt;/span>_watchers&lt;span class="token punctuation">,&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token punctuation">}&lt;/span>
    &lt;span class="token keyword">let&lt;/span> i &lt;span class="token operator">=&lt;/span> &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps&lt;span class="token punctuation">.&lt;/span>length
    &lt;span class="token keyword">while&lt;/span> &lt;span class="token punctuation">(&lt;/span>i&lt;span class="token operator">--&lt;/span>&lt;span class="token punctuation">)&lt;/span> &lt;span class="token punctuation">{&lt;/span>
      &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>deps&lt;span class="token punctuation">[&lt;/span>i&lt;span class="token punctuation">]&lt;/span>&lt;span class="token punctuation">.&lt;/span>&lt;span class="token function">removeSub&lt;/span>&lt;span class="token punctuation">(&lt;/span>&lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">)&lt;/span>
    &lt;span class="token punctuation">}&lt;/span>
    &lt;span class="token keyword">this&lt;/span>&lt;span class="token punctuation">.&lt;/span>active &lt;span class="token operator">=&lt;/span> &lt;span class="token boolean">false&lt;/span>
  &lt;span class="token punctuation">}&lt;/span>
&lt;span class="token punctuation">}&lt;/span>
</code></pre>
<p><span class="token punctuation">}</span>
</p></code></pre><p></p>
</details>
<p>上面说到在 set 某个值的时候，实际上会执行 <code>watcher.update()</code> 方法。来看下这个 update 方法：</p>
<pre class="language-js"><code><span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* istanbul ignore else */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>update 方法，同步情况执行 <code>this.run()</code> ，一般情况是异步，会进入到最后个 else 里，执行 <code>queueWatcher(this)</code>。</p>
<p><code>queueWatcher</code> 里主要代码 <code>nextTick(flushSchedulerQueue)</code>，它将 watch 队列放到 nextTick 里统一执行，这也使得连续 set 同个数据两次不同值，不会更新两次视图，提升了一定性能。</p>
<h3>computed 的原理</h3>
<p>注意 watcher 实例化 constructor 最后行有个 <code>this.value</code>:</p>
<pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
  <span class="token operator">?</span> <span class="token keyword">undefined</span>
  <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>这个 value，在 <code>initComputed</code> 的时候，会对 computed 里的每个 key <code>new Watcher(...)</code>，所以可以说是 computed 的双向绑定实现即是通过 Watcher 来响应变化。</p>
<details>
  <summary>initComputed 源码函数：</summary>
<pre class="language-js"><code><span class="token keyword">const</span> computedWatcherOptions <span class="token operator">=</span> <span class="token punctuation">{</span> lazy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<p><span class="token keyword">function</span> <span class="token function">initComputed</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token operator">:</span> Component<span class="token punctuation">,</span> computed<span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// $flow-disable-line</span>
<span class="token keyword">const</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">// computed properties are just getters during SSR</span>
<span class="token keyword">const</span> isSSR <span class="token operator">=</span> <span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span></p>
<p><span class="token comment">// 遍历定义在 computed 上的 key</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token comment">// 处理自定义 getter 情况</span>
<span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">‘function’</span> <span class="token operator">?</span> userDef <span class="token operator">:</span> userDef<span class="token punctuation">.</span>get
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">‘production’</span> <span class="token operator">&&</span> getter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">warn</span><span class="token punctuation">(</span>
<span class="token template-string"><span class="token template-punctuation string"><code>&lt;/span>&lt;span class="token string">Getter is missing for computed property "&lt;/span>&lt;span class="token interpolation">&lt;span class="token interpolation-punctuation punctuation">${&lt;/span>key&lt;span class="token interpolation-punctuation punctuation">}&lt;/span>&lt;/span>&lt;span class="token string">".&lt;/span>&lt;span class="token template-punctuation string"></code></span></span><span class="token punctuation">,</span>
vm
<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 非 ssr 情况，对 key 进行 监控，ssr 下就不需要监控了</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSSR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// create internal watcher for the computed property.</span>
<span class="token comment">// 对每个key 设置 Watcher</span>
watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
vm<span class="token punctuation">,</span>
getter <span class="token operator">||</span> noop<span class="token punctuation">,</span>
noop<span class="token punctuation">,</span>
computedWatcherOptions
<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// component-defined computed properties are already defined on the</span>
<span class="token comment">// component prototype. We only need to define computed properties defined</span>
<span class="token comment">// at instantiation here.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 将 computed 里定义的 key 在实例上添加进行代理，使得可直接通过 this.xx 来访问</span>
<span class="token function">defineComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> userDef<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">‘production’</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string"><code>&lt;/span>&lt;span class="token string">The computed property "&lt;/span>&lt;span class="token interpolation">&lt;span class="token interpolation-punctuation punctuation">${&lt;/span>key&lt;span class="token interpolation-punctuation punctuation">}&lt;/span>&lt;/span>&lt;span class="token string">" is already defined in data.&lt;/span>&lt;span class="token template-punctuation string"></code></span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props <span class="token operator">&&</span> key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string"><code>&lt;/span>&lt;span class="token string">The computed property "&lt;/span>&lt;span class="token interpolation">&lt;span class="token interpolation-punctuation punctuation">${&lt;/span>key&lt;span class="token interpolation-punctuation punctuation">}&lt;/span>&lt;/span>&lt;span class="token string">" is already defined as a prop.&lt;/span>&lt;span class="token template-punctuation string"></code></span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
</details>
<p>从上面传入参数 <code>{ lazy: true }</code> 可知，初始化时 value 为 <code>undefined</code>，
<code>defineComputed(vm, key, userDef)</code> 即 <code>Object.defineProperty(target, key, sharedPropertyDefinition)</code>.
在 <code>sharedPropertyDefinition</code> 里会拿之前 watcher 过的依赖的值：</p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createComputedGetter</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">computedGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers <span class="token operator">&&</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedWatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>所以 computed 中的值在读取的时候，拿到的结果即 watcher.value。</p>
<p><strong>总结下 data 响应式流程：</strong></p>
<p>this.xx 代理到 this._data.xx 然后 _data 在 Observer 里定义过 setter getter，在初始 render 时会收集依赖到闭包的 Dep 依赖实例的数组里，在 setter 时会通知所有依赖即每个 watcher 实例进行 update 更新。</p>
<p><strong>总结下 computed 响应式流程：</strong></p>
<p>this.xx 初始化时会先创建一个 watcher，然后通过 <code>Object.defineProperty</code> 进行 setter,getter 设置，其中 getter 会得到是 watcher.value 的值。</p>
<p><strong>注意：</strong></p>
<blockquote>
<p>Observer 文件下定义了个 <code>arrayMethods</code>，该方法重写了数组方法，使得改变 push 等操作也能触发更新。</p>
</blockquote>
<pre class="language-js"><code>methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// cache original method</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token comment">// notify change</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>附：
<a href="https://github.com/tanxchen/knowledge-note/blob/master/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/vuejs/mvvm.html#L1-L137">实现vue精简版响应式代码</a></p>
</div> <div id="article-gitalk-container" class="blog-comments-wrap" data-v-4806b282></div></div></section> <footer class="bl-footer" style="position:relative;margin-top:-60px"><div class="footer-wrap"><div style="text-align:center">
      2018-present © by <a href="#" target="_blank">TanxChen</a> All Rights Reserved. <a href="http://www.miitbeian.gov.cn" target="_blank">浙ICP备18014267号-1</a></div></div></footer></div></div></div><script defer src="/blog/_nuxt/static/1636300541/article/5ce411cb9ae55c41e3feed98/state.js"></script><script src="/blog/_nuxt/b9a28b3.js" defer></script><script src="/blog/_nuxt/6f52c49.js" defer></script><script src="/blog/_nuxt/c1e6e7d.js" defer></script><script src="/blog/_nuxt/e7fe387.js" defer></script><script src="/blog/_nuxt/c57fec5.js" defer></script><script src="/blog/_nuxt/4f157bc.js" defer></script><script src="/blog/_nuxt/798d0e7.js" defer></script>
  </body>
</html>
