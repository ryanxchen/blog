<!doctype html>
<html data-n-head-ssr>
  <head>
    <title>TanxChen'blog</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"><meta data-n-head="ssr" name="keywords" content="ryanx chen blog"><meta data-n-head="ssr" data-hid="description" name="description" content="Tanx Chen's blog 编程&前端&记录总结个人成长"><base href="/blog/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link data-n-head="ssr" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script data-n-head="ssr" src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="preload" href="/blog/_nuxt/b9a28b3.js" as="script"><link rel="preload" href="/blog/_nuxt/c57fec5.js" as="script"><link rel="preload" href="/blog/_nuxt/4f157bc.js" as="script"><link rel="preload" href="/blog/_nuxt/798d0e7.js" as="script"><link rel="preload" href="/blog/_nuxt/6f52c49.js" as="script"><link rel="preload" href="/blog/_nuxt/c1e6e7d.js" as="script"><link rel="preload" href="/blog/_nuxt/e7fe387.js" as="script"><style data-vue-ssr-id="3a312388:0 f52d43e0:0 9b3ab808:0 fa7ff0ca:0 56b15182:0 f78f9946:0 01b54bb1:0 762dd866:0">a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,main,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section{display:block}[hidden]{display:none}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:"";content:none}table{border-collapse:collapse;border-spacing:0}body,html{background-color:#fff;color:#000;letter-spacing:.5px;font-family:"Source Sans Pro",Arial,sans-serif;margin:0}a,a:focus,a:hover,a:visited{color:#000;text-decoration:none}a.link{color:#2196f3}.post{padding:25px 0 15px}.post .post-title{margin:0;color:#555;text-align:left;font:700 25px/1.1 ff-tisa-web-pro,Cambria,"Times New Roman",Georgia,Times,sans-serif}.post-title a{position:relative}.post-title a:hover:after{opacity:1;transform:scaleX(1)}.post-title a:after{position:absolute;bottom:-4px;left:0;right:0;height:3px;background:#000;content:"";opacity:0;transition:transform .1s ease-in;transform:scaleX(0)}.post .post-meta{padding:0;margin:15px 0 0;color:#6e7173;display:inline-block;text-indent:.15em}.post .post-meta:before{font-family:FontAwesome;content:"\f073";padding-right:.3em}.post .post-content{clear:left;font-size:16px;line-height:1.5;color:#444;padding-top:15px;text-align:justify;word-break:break-all}.readmore{padding:20px 0;text-align:right}.readmore a{font-size:14px;color:#444;padding:5px 10px;border:1px solid #ddd;border-radius:5px}.readmore a:hover{border:1px solid #999}.readmore a:after{font-family:FontAwesome;content:"\f101";padding-left:.3em}.blog-comments-wrap{padding-bottom:20px}.mdcontent h1,.mdcontent h2,.mdcontent h3,.mdcontent h4,.mdcontent h5,.mdcontent h6{font-weight:600;line-height:1.25;margin-bottom:16px;margin-top:24px}.mdcontent h1,.mdcontent h2{border-bottom:1px solid #eaecef;padding-bottom:.3em}.mdcontent h1{font-size:2em}.mdcontent h2{font-size:1.5em}.mdcontent code{background-color:#f6f8fa;padding:4px 6px;border-radius:4px}.mdcontent code a{background-color:rgba(27,31,35,.05)}.mdcontent p{margin:6px 0}.mdcontent blockquote{border-left:.25em solid #dfe2e5;color:#6a737d;padding:0 1em}.mdcontent li,.mdcontent ul{margin:initial;padding:initial}.mdcontent ul{padding-left:2em;margin-bottom:16px;margin-top:0}.mdcontent li{list-style:disc outside none;list-style:initial}.mdcontent img{max-width:100%}.mdcontent table{margin-bottom:16px;margin-top:0;border-collapse:collapse;border-spacing:0}.mdcontent table td,.mdcontent table th{border:1px solid #dfe2e5;padding:6px 13px;text-align:center}.mdcontent pre,.mdcontent pre[class*=language-]{border:1px solid #eaecef;background-color:#f6f8fa;padding:10px 20px;border-radius:4px;font-size:85%;line-height:1.45;overflow:auto;margin:10px 0}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#e91e63}.mdcontent pre code,.mdcontent pre[class*=language-] code{color:#525252}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#389d70}.token.punctuation{color:#2973b7}.token.boolean,.token.function,.token.number{color:#e96900}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#b3b3b3}.token.entity,.token.operator,.token.url{color:#cd6767}.token.tag{color:#3ca0e6}.token.attr-name,.token.deleted,.token.namespace{color:#fc9153}.token.punctuation{color:#666}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#3fb374}.token.property{color:#4a90e2}.nuxt-progress{position:fixed;top:0;left:0;right:0;height:2px;width:0;opacity:1;transition:width .1s,opacity .4s;background-color:#000;z-index:999999}.nuxt-progress.nuxt-progress-notransition{transition:none}.nuxt-progress-failed{background-color:red}.body-container{max-width:720px;min-width:320px;box-sizing:border-box;margin:0 auto;min-height:100vh;padding-bottom:60px}@media screen and (max-width:720px){.body-container{padding:0 20px 60px}}.title[data-v-4806b282]{color:#333}.bl-header{padding:20px 0 0;text-align:left;border-bottom:1px solid #ddd;position:relative;margin-bottom:25px}.site-name{margin-bottom:40px}.description{margin:.2em 0 0;color:#999}.nav-menu{margin:10px 0 -1px;padding:0;position:absolute;right:0;bottom:0}.nav-menu a{display:inline-block;padding:3px 20px;line-height:30px;color:#444;font-size:13px;border:1px solid transparent}.nav-menu a.nuxt-link-exact-active{border:1px solid;border-color:#ddd #ddd #fff}.bl-footer{border-top:1px solid #e5e5e5;max-width:720px;margin-left:auto;margin-right:auto;line-height:1.4;height:60px;box-sizing:border-box}.footer-wrap{display:flex;align-items:center;justify-content:center;height:100%;flex-flow:wrap}</style><link rel="preload" href="/blog/_nuxt/static/1636300541/article/5ccff6409ae55c41e3feed95/state.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/article/5ccff6409ae55c41e3feed95/payload.js" as="script"><link rel="preload" href="/blog/_nuxt/static/1636300541/manifest.js" as="script">
  </head>
  <body>
    <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div><section class="container body-container" data-v-4806b282><div class="bl-header" data-v-4806b282><div class="site-name"><a href="/blog/" class="nuxt-link-active"><img src="/blog/_nuxt/img/logo_200_200.fc1fc4c.png" alt="logo" style="width:40px;height:40px;border-radius:5px"></a> <p class="description">Stay Hungry. Stay Foolish.</p></div> <div class="nav-menu"><a href="/blog/" class="current nuxt-link-active"><i class="fa fa-home"> 首页</i></a> <a href="/blog/about"><i class="fa fa-user"> 关于</i></a></div></div> <div class="post" data-v-4806b282><h1 class="post-title title" data-v-4806b282>
      Vuex源码分析
    </h1> <div class="post-meta" data-v-4806b282>2019-05-06 16:54:24</div> <div class="article-mdcontent post-content mdcontent" data-v-4806b282><p>Vuex是Vue的数据状态管理插件.将数据放在单例下的store里，对数据进行监控管理.</p>
<h3>引入、安装阶段，从入口 index.js开始</h3>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  Store<span class="token punctuation">,</span>
  install<span class="token punctuation">,</span>
  version<span class="token operator">:</span> <span class="token string">'__VERSION__'</span><span class="token punctuation">,</span>
  mapState<span class="token punctuation">,</span>
  mapMutations<span class="token punctuation">,</span>
  mapGetters<span class="token punctuation">,</span>
  mapActions<span class="token punctuation">,</span>
  createNamespacedHelpers
<span class="token punctuation">}</span>
</code></pre>
<p>导出了 Store 类和一些辅助map开头的函数。
最初在项目里使用Vuex时，<code>Vue.use(Vuex)</code>里便是调用了<code>install</code>方法。</p>
<pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">let</span> Vue
<span class="token comment">// ...</span>
<span class="token comment">// 初始install阶段，Vue.use(Vuex)会调用install方法</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">_Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Vue为store里定义，_Vue为调用install时传入的Vue</span>
  <span class="token comment">// 防止重复install</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Vue <span class="token operator">&&</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>
        <span class="token string">'[vuex] already installed. Vue.use(Vuex) should be called only once.'</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  Vue <span class="token operator">=</span> _Vue
  <span class="token comment">// applyMixin函数作用：将store注入到子组件，子组件可通过this.$store访问store</span>
  <span class="token function">applyMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>store.js里导出了<code>install</code>方法。在store.js开头定义局部 Vue 变量，用于判断是否已经装载和减少全局作用域查找。
这里调用<code>applyMixin</code>方法，它将store注入到子组件，子组件可通过this.$store访问store
<code>// applyMixin.js</code></p>
<pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> beforeCreate<span class="token operator">:</span> vuexInit <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre>
<p>applyMixin里对 vue 1.0 和 2.0 版本进行了判断，2.0下在<code>beforeCreate</code>阶段注入<code>store</code></p>
<pre class="language-js"><code><span class="token comment">// 子组件可以通过this.$store来访问store</span>
<span class="token keyword">function</span> <span class="token function">vuexInit</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options
  <span class="token comment">// 注入store</span>
  <span class="token comment">// 初始时，在根组件上，调用者会传入store，所以会进入if逻辑</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// options上的store可以为 function，</span>
    <span class="token comment">// 这类似于 vue 里的 data return 的是个 function，防止多个 store下，里面的数据被共享</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>store <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> options<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> options<span class="token punctuation">.</span>store
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>parent <span class="token operator">&&</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在子组件上，初始化时未传入store，则从父组件中获取store</span>
    <span class="token comment">// 公用了一份初始根组件时传入的全局的store</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>$store
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3>new Store实例化阶段</h3>
<pre class="language-js"><code>  <span class="token comment">// plugins为外部传入的插件</span>
  <span class="token comment">// strict为默认不开启严格模式（严格模式：只能在mutation里进行数据更改，在action等其他位置进行数据更改会抛出错误）</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    strict <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> options
<p><span class="token comment">// 定义store 内部状态</span>
<span class="token comment">// 用于判断是否在commit环节的flag，保证只在mutation环境改变state</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">// actions操作对象</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">// 发布订阅模式下的订阅函数集合</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_actionSubscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// mutations操作对象</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_mutations <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">// 封装后的getters集合对象</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_wrappedGetters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">/**</span></p>
<ul>
<li>格式化 options，也是该源码阅读的核心重点，</li>
<li>在非模块模式（普通用法传入options）或 在按模块开发方式传入store时，存储处理过的modules</li>
<li>this._modules = {</li>
<li>root: {</li>
<li>
<pre><code>context: {dispatch: ƒ, commit: ƒ},
</code></pre>
</li>
<li>
<pre><code>runtime: false,
</code></pre>
</li>
<li>
<pre><code>state: {…},
</code></pre>
</li>
<li>
<pre><code>_children: {},
</code></pre>
</li>
<li>
<pre><code>_rawModule: {state: {…}, actions: {…}, mutations: {…}, plugins: Array(1)},
</code></pre>
</li>
<li>
<pre><code>namespaced: false
</code></pre>
</li>
<li>},</li>
<li><strong>proto</strong>: {</li>
<li>get: ƒ (path)</li>
<li>getNamespace: ƒ getNamespace(path)</li>
<li>register: ƒ register(path, rawModule, runtime)</li>
<li>unregister: ƒ unregister(path)</li>
<li>update: ƒ update$1(rawRootModule)</li>
<li>constructor: ƒ ModuleCollection(rawRootModule)</li>
<li><strong>proto</strong>: {…}</li>
<li>}</li>
<li>}
*/
<span class="token keyword">this</span><span class="token punctuation">.</span>_modules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleCollection</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token comment">// 模块命名空间map</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_modulesNamespaceMap <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">// 发布订阅模式下的订阅函数集合</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_subscribers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// vue实例，用到watch监视变化功能</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_watcherVM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// …</span>
<span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">)</span></li>
</ul>
<p><span class="token comment">// initialize the store vm, which is responsible for the reactivity</span>
<span class="token comment">// (also registers _wrappedGetters as computed properties)</span>
<span class="token function">resetStoreVM</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span></p>
<p><span class="token comment">// 调用传入的各种插件</span>
plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">plugin</span> <span class="token operator">=></span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span></p>
<p><span class="token keyword">const</span> useDevtools <span class="token operator">=</span> options<span class="token punctuation">.</span>devtools <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>devtools <span class="token operator">:</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>devtools
<span class="token keyword">if</span> <span class="token punctuation">(</span>useDevtools<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">devtoolPlugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
<p>在 <code>constructor</code> 里主要操作为： 格式化modules，安装 module，初始化 store vm, 安装 plugins</p>
<h3>格式化modules，即 <code>this._modules = new ModuleCollection(options)</code></h3>
<p>由于使用单一状态树，应用的所有状态会集中到一个比较大的对象。当应用变得非常复杂时，store 对象就有可能变得相当臃肿。</p>
<p>为了解决以上问题，Vuex 允许我们将 store 分割成模块（module）。
每个模块拥有自己的 state、mutation、action、getter、甚至是嵌套子模块——从上至下进行同样方式的分割：</p>
<pre class="language-js"><code><span class="token keyword">const</span> moduleA <span class="token operator">=</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<p><span class="token keyword">const</span> moduleB <span class="token operator">=</span> <span class="token punctuation">{</span>
state<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">…</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
mutations<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">…</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
actions<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">…</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></p>
<p><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
state<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">…</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
modules<span class="token operator">:</span> <span class="token punctuation">{</span>
a<span class="token operator">:</span> moduleA<span class="token punctuation">,</span>
b<span class="token operator">:</span> moduleB
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</p></code></pre><p></p>
<p>代码被分割到 <code>./module/module-collection</code> 文件夹下。
初始化时，执行 <code>register</code> 方法</p>
<pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rawRootModule<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre>
<p>register 接收3个参数</p>
<ul>
<li>path：路径，模块tree的路径</li>
<li>rawModule：最初 <code>new Store</code> 时传入的 <code>options</code></li>
<li>runtime：是否是运行时创建的模块,在初始化根模块时为 false， 其他情况为 true，理解为 初始化时的 flag</li>
</ul>
<p>如初始化 register 时，参数为：<code>path: [], rawModule: options, runtime: false</code></p>
<pre class="language-js"><code><span class="token function">register</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> rawModule<span class="token punctuation">,</span> runtime <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// path: [], rawModule: options, runtime: false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对构造器传入的options的getters、mutations、actions进行dev环境的格式校验</span>
    <span class="token comment">// 非预期的格式会抛出错误</span>
    <span class="token function">assertRawModule</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> rawModule<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<p><span class="token comment">// 初始化module</span>
<span class="token keyword">const</span> newModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
<span class="token comment">// 第一次初始化时，执行if代码块，path为[]</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> newModule
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token comment">// 获取当前module的parent</span>
<span class="token keyword">const</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 添加child</span>
parent<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newModule<span class="token punctuation">)</span>
<span class="token punctuation">}</span></p>
<p><span class="token comment">// 递归注册嵌套的module</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">forEachValue</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">rawChildModule<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> rawChildModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
<p>register 里的逻辑大致为</p>
<ul>
<li>校验传入的options格式，非预期的格式会抛出错误</li>
<li>实例化 <code>Module</code>，初始化时 模块 tree 的根即为 root，之后 addChild 添加的子模块 即会放入到 root._children 里，逐级对包含的所以模块进行递归 register，以形式 模块 tree</li>
</ul>
<p>root格式如下：</p>
<pre class="language-js"><code>root<span class="token operator">:</span> <span class="token punctuation">{</span>
  context<span class="token operator">:</span> <span class="token punctuation">{</span>dispatch<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> commit<span class="token operator">:</span> ƒ<span class="token punctuation">}</span><span class="token punctuation">,</span>
  runtime<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span>
  _children<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  _rawModule<span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> actions<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> mutations<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> plugins<span class="token operator">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  namespaced<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre>
<h4>初始化module</h4>
<pre class="language-js"><code><span class="token comment">// 初始化module</span>
<span class="token keyword">const</span> newModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span>
</code></pre>
<p>Module 定义在 <code>./module/module.js</code> 里</p>
<p>构造函数：</p>
<pre class="language-js"><code><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">rawModule<span class="token punctuation">,</span> runtime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// rawModule: options, runtime: false</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>runtime <span class="token operator">=</span> runtime
  <span class="token comment">// 存储module子项</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_children <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 存储初始化时传入的原始options</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule <span class="token operator">=</span> rawModule
  <span class="token keyword">const</span> rawState <span class="token operator">=</span> rawModule<span class="token punctuation">.</span>state
<p><span class="token comment">// 兼容module形式里state传入函数形式，类似 组件中的 data，总是return 一个Object，来防止对象被共享</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> rawState <span class="token operator">===</span> <span class="token string">‘function’</span> <span class="token operator">?</span> <span class="token function">rawState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> rawState<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
<p>屡下 模块初始化 思路：</p>
<ul>
<li>对初始传入的 options 进行模块 实例化，</li>
<li>里面包含了子模块的话 会被递归 放进 root._children 对象里，形成一颗 模块 tree，</li>
<li>并且 通过 <code>forEachMutation</code> 包装函数等的类似方法，子模块在执行 action、mutation 方法时也只是执行的是子模块里对应的方法，</li>
<li>每个模块的 _rawModule 即为 定义时 传入的 options</li>
<li>每个模块的 state 即为 定义时 传入的 options.state</li>
</ul>
<h3>安装模块</h3>
<pre class="language-js"><code><span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
</code></pre>
<p>在模块被初始化定义后，通过 installModule 对 state, actions, mutations, getters 进行初始化处理。</p>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">installModule</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">,</span> module<span class="token punctuation">,</span> hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// this, state(this._modules.root.state), [], this._modules.root</span>
  <span class="token comment">// 是root时，path为[]</span>
  <span class="token keyword">const</span> isRoot <span class="token operator">=</span> <span class="token operator">!</span>path<span class="token punctuation">.</span>length
  <span class="token comment">//  modules: {</span>
  <span class="token comment">//     a: moduleA,</span>
  <span class="token comment">//     b: moduleB</span>
  <span class="token comment">//   }</span>
  <span class="token comment">// modules.a 的命名空间为 'a/'</span>
  <span class="token keyword">const</span> namespace <span class="token operator">=</span> store<span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<p><span class="token comment">// 存储namespace对应的module于_modulesNamespaceMap</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>namespaced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
store<span class="token punctuation">.</span>_modulesNamespaceMap<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> module
<span class="token punctuation">}</span></p>
<p><span class="token comment">// 设置 state</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot <span class="token operator">&&</span> <span class="token operator">!</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> parentState <span class="token operator">=</span> <span class="token function">getNestedState</span><span class="token punctuation">(</span>rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> moduleName <span class="token operator">=</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
store<span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parentState<span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> module<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></p>
<p><span class="token keyword">const</span> local <span class="token operator">=</span> module<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token function">makeLocalContext</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> path<span class="token punctuation">)</span></p>
<p><span class="token comment">// 拼接namespace，如：</span>
<span class="token comment">// modules: {</span>
<span class="token comment">//   account: {</span>
<span class="token comment">//     namespaced: true,</span>
<span class="token comment">//     state: { … }, // 模块内的状态已经是嵌套的了，使用 <code>namespaced</code> 属性不会对其产生影响</span>
<span class="token comment">//     getters: {</span>
<span class="token comment">//       isAdmin () { … } // -> getters[‘account/isAdmin’]</span>
<span class="token comment">//     },</span>
<span class="token comment">//     actions: {</span>
<span class="token comment">//       login () { … } // -> dispatch(‘account/login’)</span>
<span class="token comment">//     },</span>
<span class="token comment">//     mutations: {</span>
<span class="token comment">//       login () { … } // -> commit(‘account/login’)</span>
<span class="token comment">//     }</span>
<span class="token comment">//   }</span>
<span class="token comment">// }</span>
module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key
<span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></p>
<p>module<span class="token punctuation">.</span><span class="token function">forEachAction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> type <span class="token operator">=</span> action<span class="token punctuation">.</span>root <span class="token operator">?</span> key <span class="token operator">:</span> namespace <span class="token operator">+</span> key
<span class="token keyword">const</span> handler <span class="token operator">=</span> action<span class="token punctuation">.</span>handler <span class="token operator">||</span> action
<span class="token function">registerAction</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></p>
<p>module<span class="token punctuation">.</span><span class="token function">forEachGetter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">getter<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key
<span class="token function">registerGetter</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> getter<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></p>
<p><span class="token comment">// 递归install子项</span>
module<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> hot<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
<h4>分析下 registerMutation 的注册</h4>
<p>在这里先通过 forEachMutation 方法, 传入对应的模块的 mutation 和 key，
registerMutation 里将我们项目里定义的 mutations 方法以 key-value 形式存入 _mutations 里，在传入的时候 将 state 作为第一参数，我们自己传入的为第二参数形式，这里使得如文档里所说一样形式使用：</p>
<pre class="language-js"><code><span class="token comment">// ...</span>
mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token function">increment</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>count <span class="token operator">+=</span> payload<span class="token punctuation">.</span>amount
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>这里会对命名空间进行处理，假如模块 A 中有名为 add 的 mutation 函数，那么在注册过程中会变成 a/add</p>
</blockquote>
<p>相关 Mutation 注册代码：
->>>>>>>>>>>></p>
<pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function">forEachMutation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> namespacedType <span class="token operator">=</span> namespace <span class="token operator">+</span> key
  <span class="token function">registerMutation</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> namespacedType<span class="token punctuation">,</span> mutation<span class="token punctuation">,</span> local<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//</span>
<span class="token function">forEachMutation</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule<span class="token punctuation">.</span>mutations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">forEachValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rawModule<span class="token punctuation">.</span>mutations<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//</span>
<span class="token keyword">function</span> <span class="token function">registerMutation</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">wrappedMutationHandler</span> <span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</p>
<h4>registerAction 的注册</h4>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">registerAction</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> type<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> local</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entry <span class="token operator">=</span> store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  entry<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">wrappedActionHandler</span> <span class="token punctuation">(</span><span class="token parameter">payload<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      dispatch<span class="token operator">:</span> local<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span>
      commit<span class="token operator">:</span> local<span class="token punctuation">.</span>commit<span class="token punctuation">,</span>
      getters<span class="token operator">:</span> local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>
      state<span class="token operator">:</span> local<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
      rootGetters<span class="token operator">:</span> store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>
      rootState<span class="token operator">:</span> store<span class="token punctuation">.</span>state
    <span class="token punctuation">}</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> cb<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPromise</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        store<span class="token punctuation">.</span>_devtoolHook<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'vuex:error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> err
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里将 <code>{ dispatch commit getters state rootGetters rootState }</code> 作为第一参数，将自己dispatch 时传入的参数作为第二参数，所以有了文档里所说的书写形式：</p>
<pre class="language-js"><code><span class="token comment">// 自己项目里的 actions.js</span>
<span class="token function">toggleMenu</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> commit <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'TOGGLE_MENU'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// or</span>
<span class="token function">setSidebarMenuList</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> userType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  context<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'SET_SIDEBAR_MENU_LIST'</span><span class="token punctuation">,</span> userType<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>registerAction 里 处理了 promise 情况，所以 store.dispatch 可以处理被触发的 action 的处理函数返回的 Promise，并且 store.dispatch 仍旧返回 Promise</p>
</blockquote>
<p>所以我们可以这么来写：</p>
<pre class="language-js"><code><span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> user</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'auth_request'</span><span class="token punctuation">)</span>
    <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>url<span class="token operator">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> user<span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">resp</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>token
        <span class="token keyword">const</span> user <span class="token operator">=</span> resp<span class="token punctuation">.</span>data<span class="token punctuation">.</span>user
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
        axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>common<span class="token punctuation">[</span><span class="token string">'Authorization'</span><span class="token punctuation">]</span> <span class="token operator">=</span> token
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'auth_success'</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'auth_error'</span><span class="token punctuation">)</span>
        localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">register</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'register'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>将处理的请求提取到了vuex里，也使得页面里代码更加简洁了。只保留了业务逻辑。</p>
<h4>registerGetter 的注册</h4>
<pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">return</span> <span class="token function">rawGetter</span><span class="token punctuation">(</span>
  local<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment">// local state</span>
  local<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> <span class="token comment">// local getters</span>
  store<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token comment">// root state</span>
  store<span class="token punctuation">.</span>getters <span class="token comment">// root getters</span>
<span class="token punctuation">)</span>
</code></pre>
<p>getter 这里先处理了命名空间，然后这里接收 4 个参数。
前面两个为模块内的 local state ，local getters，后两个参数为根节点上的内容 root state，root getters。
当然，没使用模块形式的话，两者相同。</p>
<h3>resetStoreVM(this, state)</h3>
<pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">resetStoreVM</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> state<span class="token punctuation">,</span> hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldVm <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm
<p><span class="token comment">// bind store public getters</span>
store<span class="token punctuation">.</span>getters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> wrappedGetters <span class="token operator">=</span> store<span class="token punctuation">.</span>_wrappedGetters
<span class="token keyword">const</span> computed <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token function">forEachValue</span><span class="token punctuation">(</span>wrappedGetters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
<span class="token comment">// use computed to leverage its lazy-caching mechanism</span>
computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
<span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>
enumerable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// for local getters</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></p>
<p><span class="token comment">// …</span>
store<span class="token punctuation">.</span>_vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
data<span class="token operator">:</span> <span class="token punctuation">{</span>
$$state<span class="token operator">:</span> state
<span class="token punctuation">}</span><span class="token punctuation">,</span>
computed
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// …</span>
<span class="token punctuation">}</span>
</p></code></pre><p></p>
<p>resetStoreVM 的工作是 实例化一个 vue 实例，并将 getters 里定义的方法 通过 Object.defineProperty 来进行绑定到 store.getters 上，
并作为 computed 计算属性，在state变化时，getter 能响应式变化。
在实际调用 即为如下关系：</p>
<pre class="language-js"><code><span class="token comment">// 这里使得vm.$store.state 取到 vm._data.$$state</span>
<span class="token keyword">get</span> <span class="token function">state</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-js"><code>store<span class="token punctuation">.</span>state <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state
store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>a <span class="token operator">=</span> store<span class="token punctuation">.</span>a <span class="token operator">=</span> store<span class="token punctuation">.</span>_vm<span class="token punctuation">.</span>_data<span class="token punctuation">.</span>$$state<span class="token punctuation">.</span>a
</code></pre>
<p>Vuex 还有一些map开头的辅助函数，这些 handler 通过 hook 达到了简写的目的。
Vuex 本身是 Vue 的插件形式，其自身继续延续支持插件形式。<code>replaceState</code>,<code>subscribe</code>通常会在插件里用到。</p>
<pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>mutation<span class="token punctuation">.</span>payload<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</div> <div id="article-gitalk-container" class="blog-comments-wrap" data-v-4806b282></div></div></section> <footer class="bl-footer" style="position:relative;margin-top:-60px"><div class="footer-wrap"><div style="text-align:center">
      2018-present © by <a href="#" target="_blank">TanxChen</a> All Rights Reserved. <a href="http://www.miitbeian.gov.cn" target="_blank">浙ICP备18014267号-1</a></div></div></footer></div></div></div><script defer src="/blog/_nuxt/static/1636300541/article/5ccff6409ae55c41e3feed95/state.js"></script><script src="/blog/_nuxt/b9a28b3.js" defer></script><script src="/blog/_nuxt/6f52c49.js" defer></script><script src="/blog/_nuxt/c1e6e7d.js" defer></script><script src="/blog/_nuxt/e7fe387.js" defer></script><script src="/blog/_nuxt/c57fec5.js" defer></script><script src="/blog/_nuxt/4f157bc.js" defer></script><script src="/blog/_nuxt/798d0e7.js" defer></script>
  </body>
</html>
